{"data":{"allAnantCassandralinks":{"edges":[{"node":{"title":"Example: Deploying Cassandra with Stateful Sets","alternative_id":12459,"content":"<p>Example: Deploying Cassandra with Stateful Sets - Kubernetes</p><header><p></p><h5><a href=\"https://kubernetes.io/docs/home/\">DOCUMENTATION</a>\n\t\t\n\t\t\n\t\t<a href=\"https://kubernetes.io/docs/setup/\">SETUP</a>\n\t\t\n\t\t\n\t\t<a href=\"https://kubernetes.io/docs/concepts/\">CONCEPTS</a>\n\t\t\n\t\t\n\t\t<a href=\"https://kubernetes.io/docs/tasks/\">TASKS</a>\n\t\t\n\t\t\n\t\t<a href=\"https://kubernetes.io/docs/tutorials/\" class=\"YAH\">TUTORIALS</a>\n\t\t\n\t\t\n\t\t<a href=\"https://kubernetes.io/docs/reference/\">REFERENCE</a>\n\t\t\n\t\t\n\t\t<a href=\"https://kubernetes.io/docs/contribute/\">CONTRIBUTE</a>\n\t\t\n\t</h5><section id=\"encyclopedia\"><div id=\"docsContent\"><p><a href=\"https://github.com/kubernetes/website/edit/master/content/en/docs/tutorials/stateful-application/cassandra.md\" id=\"editPageButton\" target=\"_blank\">Edit This Page</a></p><p>This tutorial shows you how to develop a native cloud <a href=\"http://cassandra.apache.org/\" target=\"_blank\">Cassandra</a> deployment on Kubernetes. In this example, a custom Cassandra <em>SeedProvider</em> enables Cassandra to discover new Cassandra nodes as they join the cluster.</p><p><em>StatefulSets</em> make it easier to deploy stateful applications within a clustered environment. For more information on the features used in this tutorial, see the <a href=\"https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/\"><em>StatefulSet</em></a> documentation.</p><p><strong>Cassandra on Docker</strong></p><p>The <em>Pods</em> in this tutorial use the <a href=\"https://github.com/kubernetes/examples/blob/master/cassandra/image/Dockerfile\" target=\"_blank\"><code>gcr.io/google-samples/cassandra:v13</code></a>\nimage from Googleâ€™s <a href=\"https://cloud.google.com/container-registry/docs/\" target=\"_blank\">container registry</a>.\nThe Docker image above is based on <a href=\"https://github.com/kubernetes/kubernetes/tree/master/build/debian-base\" target=\"_blank\">debian-base</a>\nand includes OpenJDK 8.</p><p>This image includes a standard Cassandra installation from the Apache Debian repo.\nBy using environment variables you can change values that are inserted into <code>cassandra.yaml</code>.</p><table><thead><tr><th>ENV VAR</th>\n<th align=\"center\">DEFAULT VALUE</th>\n</tr></thead><tbody><tr><td><code>CASSANDRA_CLUSTER_NAME</code></td>\n<td align=\"center\"><code>'Test Cluster'</code></td>\n</tr><tr><td><code>CASSANDRA_NUM_TOKENS</code></td>\n<td align=\"center\"><code>32</code></td>\n</tr><tr><td><code>CASSANDRA_RPC_ADDRESS</code></td>\n<td align=\"center\"><code>0.0.0.0</code></td>\n</tr></tbody></table><ul id=\"markdown-toc\"><li><a href=\"#objectives\">Objectives</a></li>\n<li><a href=\"#before-you-begin\">Before you begin</a></li>\n<li><a href=\"#creating-a-cassandra-headless-service\">Creating a Cassandra Headless Service</a></li>\n<li><a href=\"#using-a-statefulset-to-create-a-cassandra-ring\">Using a StatefulSet to Create a Cassandra Ring</a></li>\n<li><a href=\"#validating-the-cassandra-statefulset\">Validating The Cassandra StatefulSet</a></li>\n<li><a href=\"#modifying-the-cassandra-statefulset\">Modifying the Cassandra StatefulSet</a></li>\n<li><a href=\"#cleaning-up\">Cleaning up</a></li>\n<li><a href=\"#what-s-next\">What's next</a></li>\n</ul><h2 id=\"objectives\">Objectives</h2><h2 id=\"before-you-begin\">Before you begin</h2><p>To complete this tutorial, you should already have a basic familiarity with <a href=\"https://kubernetes.io/docs/concepts/workloads/pods/pod/\">Pods</a>, <a href=\"https://kubernetes.io/docs/concepts/services-networking/service/\">Services</a>, and <a href=\"https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/\">StatefulSets</a>. In addition, you should:</p><blockquote class=\"note\">\n  <p><strong>Note:</strong> Please read the <a href=\"https://kubernetes.io/docs/setup/pick-right-solution/\">getting started guides</a> if you do not already have a cluster.</p>\n</blockquote><h3 id=\"additional-minikube-setup-instructions\">Additional Minikube Setup Instructions</h3><blockquote class=\"caution\">\n  <div><p><strong>Caution:</strong> <a href=\"https://kubernetes.io/docs/getting-started-guides/minikube/\">Minikube</a> defaults to 1024MB of memory and 1 CPU. Running Minikube with the default resource configuration results in insufficient resource errors during this tutorial. To avoid these errors, start Minikube with the following settings:</p><div class=\"highlight\"><pre class=\"language-shell\" data-lang=\"shell\">minikube start --memory 5120 --cpus=4</pre></div></div>\n</blockquote><p>A Kubernetes <a href=\"https://kubernetes.io/docs/concepts/services-networking/service/\">Service</a> describes a set of <a href=\"https://kubernetes.io/docs/concepts/workloads/pods/pod/\">Pods</a> that perform the same task.</p><p>The following <code>Service</code> is used for DNS lookups between Cassandra Pods and clients within the Kubernetes cluster.</p><table class=\"includecode\" id=\"application-cassandra-cassandra-service-yaml\"><thead><tr><th>\n                <a href=\"https://raw.githubusercontent.com/kubernetes/website/master/content/en/examples/application/cassandra/cassandra-service.yaml\" download=\"application/cassandra/cassandra-service.yaml\">\n                    <code>application/cassandra/cassandra-service.yaml</code>\n                </a>\n                <img src=\"https://d33wubrfki0l68.cloudfront.net/951ae1fcc65e28202164b32c13fa7ae04fab4a0b/b77dc/images/copycode.svg\" title=\"Copy application/cassandra/cassandra-service.yaml to clipboard\" alt=\"image\" /></th>\n        </tr></thead><tbody><tr><td><div class=\"highlight\"><pre class=\"language-yaml\" data-lang=\"yaml\">apiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: cassandra\n  name: cassandra\nspec:\n  clusterIP: None\n  ports:\n  - port: 9042\n  selector:\n    app: cassandra\n</pre></div>  </td>\n        </tr></tbody></table><ol><li>Launch a terminal window in the directory you downloaded the manifest files.</li>\n<li><p>Create a Service to track all Cassandra StatefulSet nodes from the <code>cassandra-service.yaml</code> file:</p>\n<div class=\"highlight\"><pre class=\"language-shell\" data-lang=\"shell\">kubectl create -f https://k8s.io/examples/application/cassandra/cassandra-service.yaml</pre></div></li>\n</ol><h3 id=\"validating-optional\">Validating (optional)</h3><p>Get the Cassandra Service.</p><div class=\"highlight\"><pre class=\"language-shell\" data-lang=\"shell\">kubectl get svc cassandra</pre></div><p>The response is</p><pre>NAME        TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE\ncassandra   ClusterIP   None         &lt;none&gt;        9042/TCP   45s\n</pre><p>Service creation failed if anything else is returned. Read <a href=\"https://kubernetes.io/docs/tasks/debug-application-cluster/debug-service/\">Debug Services</a> for common issues.</p><p>The StatefulSet manifest, included below, creates a Cassandra ring that consists of three Pods.</p><blockquote class=\"note\">\n  <p><strong>Note:</strong> This example uses the default provisioner for Minikube. Please update the following StatefulSet for the cloud you are working with.</p>\n</blockquote><ol><li>Update the StatefulSet if necessary.</li>\n<li><p>Create the Cassandra StatefulSet from the <code>cassandra-statefulset.yaml</code> file:</p>\n<div class=\"highlight\"><pre class=\"language-shell\" data-lang=\"shell\">kubectl create -f https://k8s.io/examples/application/cassandra/cassandra-statefulset.yaml</pre></div></li>\n</ol><ol><li><p>Get the Cassandra StatefulSet:</p>\n<div class=\"highlight\"><pre class=\"language-shell\" data-lang=\"shell\">kubectl get statefulset cassandra</pre></div>\n<p>The response should be:</p>\n<pre>NAME        DESIRED   CURRENT   AGE\ncassandra   3         0         13s\n</pre>\n<p>The <code>StatefulSet</code> resource deploys Pods sequentially.</p></li>\n<li><p>Get the Pods to see the ordered creation status:</p>\n<div class=\"highlight\"><pre class=\"language-shell\" data-lang=\"shell\">kubectl get pods -l=\"app=cassandra\"</pre></div>\n<p>The response should be:</p>\n<div class=\"highlight\"><pre class=\"language-shell\" data-lang=\"shell\">NAME          READY     STATUS              RESTARTS   AGE\ncassandra-0   1/1       Running             0          1m\ncassandra-1   0/1       ContainerCreating   0          8s</pre></div>\n<p>It can take several minutes for all three Pods to deploy. Once they are deployed, the same command returns:</p>\n<pre>NAME          READY     STATUS    RESTARTS   AGE\ncassandra-0   1/1       Running   0          10m\ncassandra-1   1/1       Running   0          9m\ncassandra-2   1/1       Running   0          8m\n</pre></li>\n<li><p>Run the Cassandra <a href=\"https://wiki.apache.org/cassandra/NodeTool\" target=\"_blank\">nodetool</a> to display the status of the ring.</p>\n<div class=\"highlight\"><pre class=\"language-shell\" data-lang=\"shell\">kubectl exec -it cassandra-0 -- nodetool status</pre></div>\n<p>The response should look something like this:</p>\n<pre>Datacenter: DC1-K8Demo\n======================\nStatus=Up/Down\n|/ State=Normal/Leaving/Joining/Moving\n--  Address     Load       Tokens       Owns (effective)  Host ID                               Rack\nUN  172.17.0.5  83.57 KiB  32           74.0%             e2dd09e6-d9d3-477e-96c5-45094c08db0f  Rack1-K8Demo\nUN  172.17.0.4  101.04 KiB  32           58.8%             f89d6835-3a42-4419-92b3-0e62cae1479c  Rack1-K8Demo\nUN  172.17.0.6  84.74 KiB  32           67.1%             a6a1e8c2-3dc5-4417-b1a0-26507af2aaad  Rack1-K8Demo\n</pre></li>\n</ol><p>Use <code>kubectl edit</code> to modify the size of a Cassandra StatefulSet.</p><ol><li><p>Run the following command:</p>\n<div class=\"highlight\"><pre class=\"language-shell\" data-lang=\"shell\">kubectl edit statefulset cassandra</pre></div>\n<p>This command opens an editor in your terminal. The line you need to change is the <code>replicas</code> field. The following sample is an excerpt of the <code>StatefulSet</code> file:</p>\n<div class=\"highlight\"><pre class=\"language-yaml\" data-lang=\"yaml\"># Please edit the object below. Lines beginning with a '#' will be ignored,\n# and an empty file will abort the edit. If an error occurs while saving this file will be\n# reopened with the relevant failures.\n#\napiVersion: apps/v1 # for versions before 1.9.0 use apps/v1beta2\nkind: StatefulSet\nmetadata:\n  creationTimestamp: 2016-08-13T18:40:58Z\n  generation: 1\n  labels:\n  app: cassandra\n  name: cassandra\n  namespace: default\n  resourceVersion: \"323\"\n  selfLink: /apis/apps/v1/namespaces/default/statefulsets/cassandra\n  uid: 7a219483-6185-11e6-a910-42010a8a0fc0\nspec:\n  replicas: 3</pre></div></li>\n<li><p>Change the number of replicas to 4, and then save the manifest.</p>\n<p>The <code>StatefulSet</code> now contains 4 Pods.</p></li>\n<li><p>Get the Cassandra StatefulSet to verify:</p>\n<div class=\"highlight\"><pre class=\"language-shell\" data-lang=\"shell\">kubectl get statefulset cassandra</pre></div>\n<p>The response should be</p>\n<pre>NAME        DESIRED   CURRENT   AGE\ncassandra   4         4         36m\n</pre></li>\n</ol><h2 id=\"cleaning-up\">Cleaning up</h2><p>Deleting or scaling a StatefulSet down does not delete the volumes associated with the StatefulSet. This setting is for your safety because your data is more valuable than automatically purging all related StatefulSet resources.</p><blockquote class=\"warning\">\n  <p><strong>Warning:</strong> Depending on the storage class and reclaim policy, deleting the <em>PersistentVolumeClaims</em> may cause the associated volumes to also be deleted. Never assume youâ€™ll be able to access data if its volume claims are deleted.</p>\n</blockquote><ol><li><p>Run the following commands (chained together into a single command) to delete everything in the Cassandra <code>StatefulSet</code>:</p>\n<div class=\"highlight\"><pre class=\"language-shell\" data-lang=\"shell\">grace=$(kubectl get po cassandra-0 -o=jsonpath='{.spec.terminationGracePeriodSeconds}') \\\n  &amp;&amp; kubectl delete statefulset -l app=cassandra \\\n  &amp;&amp; echo \"Sleeping $grace\" \\\n  &amp;&amp; sleep $grace \\\n  &amp;&amp; kubectl delete pvc -l app=cassandra</pre></div></li>\n<li><p>Run the following command to delete the Cassandra Service.</p>\n<div class=\"highlight\"><pre class=\"language-shell\" data-lang=\"shell\">kubectl delete service -l app=cassandra</pre></div></li>\n</ol><h2 id=\"what-s-next\">What's next</h2><ul><li>Learn how to <a href=\"https://kubernetes.io/docs/tasks/run-application/scale-stateful-set/\">Scale a StatefulSet</a>.</li>\n<li>Learn more about the <a href=\"https://github.com/kubernetes/examples/blob/master/cassandra/java/src/main/java/io/k8s/cassandra/KubernetesSeedProvider.java\" target=\"_blank\"><em>KubernetesSeedProvider</em></a></li>\n<li>See more custom <a href=\"https://git.k8s.io/examples/cassandra/java/README.md\" target=\"_blank\">Seed Provider Configurations</a></li>\n</ul></div></section></header>"}}]}},"pageContext":{"alternative_id":12459}}