{"data":{"allAnantCassandralinks":{"edges":[{"node":{"title":"Lessons Learned From Running 1800 Clusters (Brooke Jensen, Instaclust…","alternative_id":13007,"content":"Lessons Learned From Running 1800 Clusters (Brooke Jensen, Instaclust…\n      \n      \n      <div id=\"main-nav\" class=\"contain-to-grid fixed\"><p><a class=\"item\" href=\"https://www.slideshare.net/\" aria-labelledby=\"#home\">\n            \n            </a><label id=\"home\">SlideShare</label>\n          \n          <a class=\"item\" href=\"https://www.slideshare.net/explore\" aria-labelledby=\"#explore\">\n            <i class=\"fa fa-compass\">\n            </i></a><label id=\"explore\">Explore</label>\n          \n          \n            <a class=\"item\" href=\"https://www.slideshare.net/login\" aria-labelledby=\"#you\">\n              <i class=\"fa fa-user\">\n              </i></a><label id=\"you\">You</label>\n            </p></div>\n    <div class=\"wrapper\"><p>Successfully reported this slideshow.</p><div id=\"slideview-container\" class=\"\"><div class=\"row\"><div id=\"main-panel\" class=\"small-12 large-8 columns\"><div class=\"sectionElements\"><div class=\"playerWrapper\"><div><div class=\"player lightPlayer fluidImage presentation_player\" id=\"svPlayerId\">Lessons Learned From Running 1800 Clusters (Brooke Jensen, Instaclustr) | Cassandra Summit 2016<div class=\"stage valign-first-slide\"><div class=\"slide_container\"><section data-index=\"1\" class=\"slide show\" itemprop=\"image\"><img class=\"slide_image\" src=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-1-638.jpg?cb=1478206889\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-1-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-1-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-1-1024.jpg?cb=1478206889\" alt=\"Brooke Jensen&#10;VP Technical Operations &amp; Customer Services&#10;Instaclustr&#10;Lessons learned from running over 1800 2000 clusters&#10;\" /></section><section data-index=\"2\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-2-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-2-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-2-1024.jpg?cb=1478206889\" alt=\"Instaclustr&#10;• Launched at 2014 Summit.&#10;• Now 25+ staff in 4 countries.&#10;• Engineering (dev &amp; ops) from Canberra, AU&#10;• Cassa...\" /></i></section><section data-index=\"3\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-3-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-3-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-3-1024.jpg?cb=1478206889\" alt=\"“Globally unique perspective of Cassandra.”&#10;• Our customer base:&#10;• Diverse. From early stage start-ups to large well-&#10;know...\" /></i></section><section data-index=\"4\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-4-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-4-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-4-1024.jpg?cb=1478206889\" alt=\"About Me&#10;Brooke Jensen&#10;VP Technical Operations, Customer Services / Cassandra MVP&#10;• Previous: Senior Software Engineer, In...\" /></i></section><section data-index=\"5\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-5-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-5-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-5-1024.jpg?cb=1478206889\" alt=\"Talk Overview&#10;• Collection of common problems we see and manage on a daily basis.&#10;• Examples and war stories from the fiel...\" /></i></section><section data-index=\"6\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-6-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-6-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-6-1024.jpg?cb=1478206889\" alt=\"Cluster Design Basics – Racks &amp; RF&#10;• For production we recommend (minimum): 3 nodes in 3 racks with RF3.&#10; Make racks a mu...\" /></i></section><section data-index=\"7\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-7-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-7-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-7-1024.jpg?cb=1478206889\" alt=\"The case for single racks&#10;• Datastax docs suggest not to use racks?&#10;• “It’s hard to set up”&#10;• “Expanding is difficult” – n...\" /></i></section><section data-index=\"8\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-8-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-8-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-8-1024.jpg?cb=1478206889\" alt=\"Setting it up&#10;yaml:&#10;endpoint_snitch: GossipingPropertyFileSnitch&#10;cassandra-rackdc.properties:&#10;Executing 'cat /etc/cassandr...\" /></i></section><section data-index=\"9\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-9-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-9-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-9-1024.jpg?cb=1478206889\" alt=\"Compactions – the basics&#10;© DataStax, All Rights Reserved. 10&#10;• Regular compactions are an integral part of any healthy Cas...\" /></i></section><section data-index=\"10\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-10-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-10-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-10-1024.jpg?cb=1478206889\" alt=\"Monitoring Compactions&#10;$ nodetool compactionstats -H&#10;pending tasks: 130&#10;compaction type keyspace table completed total uni...\" /></i></section><section data-index=\"11\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-11-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-11-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-11-1024.jpg?cb=1478206889\" alt=\"Compactions: other things to check&#10;© DataStax, All Rights Reserved. 12&#10;\" /></i></section><section data-index=\"12\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-12-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-12-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-12-1024.jpg?cb=1478206889\" alt=\"Managing Compactions&#10;Few things you can do if compactions are causing issues (e.g. latency)&#10;Throttle: nodetool setcompacti...\" /></i></section><section data-index=\"13\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-13-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-13-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-13-1024.jpg?cb=1478206889\" alt=\"Large Partitions&#10;• One of the biggest problems we deal with. Root cause of many other issues, and a PITA to manage.&#10;• We r...\" /></i></section><section data-index=\"14\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-14-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-14-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-14-1024.jpg?cb=1478206889\" alt=\"Checking partition sizes&#10;~ $ nodetool cfstats -H keyspace.columnfamily&#10;…&#10;Compacted partition minimum bytes: 125 bytes&#10;Comp...\" /></i></section><section data-index=\"15\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-15-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-15-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-15-1024.jpg?cb=1478206889\" alt=\"Disk Usage&#10;• As a guide, maintain nodes under 70% (50% for STCS).&#10;• At 80% take action.&#10;• Why so much headroom?&#10;• Compacti...\" /></i></section><section data-index=\"16\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-16-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-16-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-16-1024.jpg?cb=1478206889\" alt=\"Try this first: stop writing data.&#10;© DataStax, All Rights Reserved. 17&#10;\" /></i></section><section data-index=\"17\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-17-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-17-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-17-1024.jpg?cb=1478206889\" alt=\"Can’t stop? Won’t stop?&#10;Quick win: clearing snapshots.&#10;nodetool cfstats or nodetool listsnapshots will show if you have an...\" /></i></section><section data-index=\"18\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-18-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-18-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-18-1024.jpg?cb=1478206889\" alt=\"Finding data to remove&#10;© DataStax, All Rights Reserved. 19&#10;I like to look at the data folders on disk – easier to identify...\" /></i></section><section data-index=\"19\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-19-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-19-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-19-1024.jpg?cb=1478206889\" alt=\"Tip: Removing data&#10;© DataStax, All Rights Reserved. 20&#10;DELETE - creates tombstones which will not be purged by compactions...\" /></i></section><section data-index=\"20\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-20-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-20-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-20-1024.jpg?cb=1478206889\" alt=\"Disk Usage – Other Actions to try&#10;• Add Nodes + run cleanups&#10;• After all new nodes are running, run nodetool cleanup on ea...\" /></i></section><section data-index=\"21\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-21-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-21-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-21-1024.jpg?cb=1478206889\" alt=\"Compaction spikes&#10;• Compactions, particularly large ones, will cause spikes in disk usage while both sets of SSTables&#10;exis...\" /></i></section><section data-index=\"22\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-22-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-22-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-22-1024.jpg?cb=1478206889\" alt=\"Compaction spikes&#10;1. Find the tmp SSTable associated with the current compaction. From this, together with %&#10;complete in c...\" /></i></section><section data-index=\"23\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-23-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-23-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-23-1024.jpg?cb=1478206889\" alt=\"Case study: Yesterday’s drama&#10;Scene:&#10;• 15 node production cluster, 12 * m4xl-1600 nodes + 3 * m4xl-800 nodes (ie 3 with ha...\" /></i></section><section data-index=\"24\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-24-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-24-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-24-1024.jpg?cb=1478206889\" alt=\"09:33:&#10;~ $ df –h&#10;Filesystem Size Used Avail Use% Mounted on&#10;/dev/md127 787G 777G 10G 99% /var/lib/cassandra&#10;11:03:&#10;Filesys...\" /></i></section><section data-index=\"25\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-25-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-25-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-25-1024.jpg?cb=1478206889\" alt=\"© DataStax, All Rights Reserved. 26&#10;13:40:&#10;Filesystem Size Used Avail Use% Mounted on&#10;/dev/md127 787G 785G 2G 100% /var/li...\" /></i></section><section data-index=\"26\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-26-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-26-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-26-1024.jpg?cb=1478206889\" alt=\"Solution was to move one CF to EBS in the background before the disk fills up.&#10;~ $ du -hs /var/lib/cassandra/data/prod/*&#10;8...\" /></i></section><section data-index=\"27\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-27-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-27-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-27-1024.jpg?cb=1478206889\" alt=\"Monitoring – how we detect problems&#10;• Client read and write latency&#10;• Local CF read and write latency&#10;• Number of reads or...\" /></i></section><section data-index=\"28\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-28-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-28-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-28-1024.jpg?cb=1478206889\" alt=\"Case study: Don’t break your cluster.&#10;WARNING! It is possible to get your cluster into a state from which you are unable t...\" /></i></section><section data-index=\"29\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-29-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-29-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-29-1024.jpg?cb=1478206889\" alt=\"“This happened during normal operations at night, so I don't think any of us were doing anything&#10;abnormal. We've been doin...\" /></i></section><section data-index=\"30\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-30-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-30-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-30-1024.jpg?cb=1478206889\" alt=\"Unthrottled data load&#10;• Load average of 56, on 8 core machines.&#10;• Nodes were saturated and exhausted heap space.&#10;• Regular...\" /></i></section><section data-index=\"31\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-31-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-31-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-31-1024.jpg?cb=1478206889\" alt=\"17 second GC pauses. Nice.&#10;Aug 16 15:51:58 INFO o.a.cassandra.service.GCInspector ConcurrentMarkSweep GC in 12416ms. CMS&#10;O...\" /></i></section><section data-index=\"32\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-32-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-32-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-32-1024.jpg?cb=1478206889\" alt=\"1. Once we got C* stable and caught up on compactions, there were still corrupt SSTables present and&#10;nodes were in an inco...\" /></i></section><section data-index=\"33\" class=\"slide\"><i class=\"fa fa-spinner fa-spin\"><img class=\"slide_image\" src=\"https://www.slideshare.net/DataStax/lessons-learned-from-running-1800-clusters\" data-small=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/85/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-33-320.jpg?cb=1478206889\" data-normal=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-33-638.jpg?cb=1478206889\" data-full=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-33-1024.jpg?cb=1478206889\" alt=\"Some final tips&#10;• When making major changes to the cluster (expanding, migrating, decomissioning), GO SLOW.&#10;• It takes lon...\" /></i></section><div class=\"j-next-container next-container\"><div class=\"content-container\"><div class=\"next-slideshow-wrapper\"><div class=\"j-next-slideshow next-slideshow\"><p>Upcoming SlideShare</p></div><p>Loading in …5</p><p>×</p></div></div></div></div></div></div></div></div></div><div class=\"slideshow-info-container\" itemscope=\"itemscope\" itemtype=\"https://schema.org/MediaObject\"><div class=\"slideshow-tabs-container show-for-medium-up\"><ul class=\"tabs\" data-tab=\"\" role=\"tablist\"><li class=\"active\" role=\"presentation\">\n                <a href=\"#comments-panel\" role=\"tab\" aria-selected=\"true\" aria-controls=\"comments-panel\">\n                  \n                    0 Comments\n                </a>\n              </li>\n            <li class=\"\" role=\"presentation\">\n              <a href=\"#likes-panel\" role=\"tab\" aria-selected=\"false\" aria-controls=\"likes-panel\">\n                <i class=\"fa fa-heart\">\n                \n                  4 Likes\n                \n              </i></a>\n            </li>\n            <li role=\"presentation\">\n              <a href=\"#stats-panel\" class=\"j-stats-tab\" role=\"tab\" aria-selected=\"false\" aria-controls=\"stats-panel\">\n                <i class=\"fa fa-bar-chart\">\n                Statistics\n              </i></a>\n            </li>\n            <li role=\"presentation\">\n              <a href=\"#notes-panel\" role=\"tab\" aria-selected=\"false\" aria-controls=\"notes-panel\">\n                <i class=\"fa fa-file-text\">\n                Notes\n              </i></a>\n            </li>\n          </ul><div class=\"tabs-content\"><div class=\"content\" id=\"likes-panel\" role=\"tabpanel\" aria-hidden=\"false\"><ul id=\"favsList\" class=\"j-favs-list notranslate user-list no-bullet\" itemtype=\"http://schema.org/UserLikes\" itemscope=\"itemscope\"><li itemtype=\"http://schema.org/Person\" itemscope=\"itemscope\">\n                      <div class=\"row\"><div class=\"small-11 columns\"><a class=\"favoriter notranslate\" title=\"MaArthur1\" rel=\"nofollow\" href=\"https://www.slideshare.net/MaArthur1?utm_campaign=profiletracking&amp;utm_medium=sssite&amp;utm_source=ssslideshow\">\n                            Ma Arthur\n                            \n                              \n                                , \n                                LofTechnology Backend Developer\n                              \n                              \n                                 at \n                                Backend Engineer\n                              \n                            \n                            \n                            </a></div></div>\n                    </li>\n                    <li itemtype=\"http://schema.org/Person\" itemscope=\"itemscope\">\n                      <div class=\"row\"><div class=\"small-11 columns\"><a class=\"favoriter notranslate\" title=\"piman78\" rel=\"nofollow\" href=\"https://www.slideshare.net/piman78?utm_campaign=profiletracking&amp;utm_medium=sssite&amp;utm_source=ssslideshow\">\n                            Pierre Carré\n                            \n                              \n                                , \n                                Responsable technique chez Orange Applications for Business\n                              \n                              \n                                 at \n                                Orange Business Services\n                              \n                            \n                            \n                            </a></div></div>\n                    </li>\n                    <li itemtype=\"http://schema.org/Person\" itemscope=\"itemscope\">\n                      <div class=\"row\"><div class=\"small-11 columns\"><a class=\"favoriter notranslate\" title=\"cmvelo\" rel=\"nofollow\" href=\"https://www.slideshare.net/cmvelo?utm_campaign=profiletracking&amp;utm_medium=sssite&amp;utm_source=ssslideshow\">\n                            Colleen Velo\n                            \n                              \n                                , \n                                Senior Technical Operations Engineer at SmartThings\n                              \n                              \n                                 at \n                                SmartThings\n                              \n                            \n                            \n                            </a></div></div>\n                    </li>\n                    <li itemtype=\"http://schema.org/Person\" itemscope=\"itemscope\">\n                      <div class=\"row\"><div class=\"small-11 columns\"><a class=\"favoriter notranslate\" title=\"kenphused\" rel=\"nofollow\" href=\"https://www.slideshare.net/kenphused?utm_campaign=profiletracking&amp;utm_medium=sssite&amp;utm_source=ssslideshow\">\n                            Ken Nordquist\n                            \n                              \n                                , \n                                Solutions Architect, Agile Software Development Leader, Entrepreneur\n                              \n                              \n                                 at \n                                DataStax\n                              \n                            \n                            \n                            </a></div></div>\n                    </li>\n              </ul></div><div class=\"content\" id=\"downloads-panel\" role=\"tabpanel\" aria-hidden=\"true\"><p>No Downloads</p></div><div class=\"content\" id=\"notes-panel\" role=\"tabpanel\" aria-hidden=\"true\"><p>No notes for slide</p>NetworkTopologyStrategy places replicas in the same data center by walking the ring clockwise until reaching the first node in another rack.  <br />Also leaves open the possibility of DC migrations later on.Datastax recommends not to use logical racks. Cause: <br />Most users tend to ignore / forget rack requirements - should be in alternating order. <br />Same number of rack as nodes? –Use racks = RF <br />Expanding is difficult – not if you’re using vnodes. <p>Makes repairing easier <br />Cluster operations <br />Minimises downtime. <br />Lose a whole rack of nodes without downtime.  <br /></p>rack and data center information for the local node defined in the cassandra-rackdc.properties <br />prefer_local=true - tells Cassandra to use the local IP address when communication is not across different data centers.Causes downtime when adding nodes. RF2 doing quorum. <p>Driver config + consistency (QUORUM, Defaultretrypolicy) <br />Change to DowngradingConsistencyRetryPolicy </p>2.1 handles compactions of large partitions better.  <br />Quorum queries do read repairs, so one slower (compacting) node will take much longer to return digest to coordinator, making the whole operation slower. SSTables per read <br />Tombstones per read <br />Indicates compactions are not keeping up or compaction strategy is not appropriate.Nodetool stop only stops current compaction, but does not prevent more compactions from occurring. So the same (problematic) compaction will be kicked off again later. <br />Compactionthroughput – on 2.1 applies to new compactions, on 2.2.5+ applies instantly. <br />Particularly in 2.0-H makes is readable. <br />50% for STCS <br />If you fill up a disk – can cause corrupt sstables, fails halfway through compactions. <br />C* doesn’t restartSnapshots can consume considerable space on disk. I like to look at the data files on disk – easier than Cfstats. <br />Look for large CFs. Can you remove data? <br />Note: might not just be your data. Space can commonly be consumed by snapshots or even system keyspaces. <br />We’ve had nodes nearly fill up because of stored hinted handoffs. <br />Be wary of changing gc_grace – make sure there are no other nodes down, or are back up within 3 hours or else the tombstone won’t get passed in HH. <br />Recovery – add ebs, start C*, compact, etc. ~25G remaining but only 4G free. Unlikely. <br />This example was SizeTieredCompactionStrategy <br />If you are watching the node closely, you can let the available disk space get VERY low during compactions (MB free). Be prepared to stop Cassandra on the node if it gets too low.Added the three 800’s previously – didn’t think they’d need the storage but needed compute <br />QUORUM - A write must be written to the commit log and memtable on a quorum of replicas I guess they were having a busy day.- when Cassandra attempts a read at CL higher than 1 it actually request data from the likely fastest node a digest from the remaining nodes. It then compares the digest values to ensure they agree.- if the don't agree, Cassandra attempts to apply the \"most recent data\" wins rule and also repair the inconsistency across nodes. To do this, it issue a query at CL=ALL- CASSANDRA 7947 (https://issues.apache.org/jira/browse/CASSANDRA-7947) changed the behaviour of Cassandra so that a failure at the original CL is report rather than a failure at CL=ALLTwo nodes up but one was missing updates/data which triggered the CL=ALL reads and failures. In our experience it is faster overall to take a slow-and-steady approach rather than overloading the cluster and having to recover it. <br />Eg. Don’t execute many rebuilds in parallel. <br /></div></div></div><div class=\"notranslate transcript add-padding-right j-transcript\"><ol class=\"j-transcripts transcripts no-bullet no-style\" itemprop=\"text\"><li>\n      1.\n    Brooke Jensen\nVP Technical Operations &amp; Customer Services\nInstaclustr\nLessons learned from running over 1800 2000 clusters\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-2-638.jpg?cb=1478206889\" title=\"Instaclustr&#10;• Launched at 2014 Summit.&#10;• Now 25+ staff in 4...\" target=\"_blank\">\n        2.\n      </a>\n    Instaclustr\n• Launched at 2014 Summit.\n• Now 25+ staff in 4 countries.\n• Engineering (dev &amp; ops) from Canberra, AU\n• Cassandra as a service (CaaS)\n• AWS, Azure, Softlayer, GCP in progress.\n• Automated provisioning – running within minutes.\n• 24/7 monitoring and response.\n• Repairs, backups, migrations, etc.\n• Expert Cassandra support.\n• Spark and Zeppelin add-ons.\n• Enterprise support\n• For customers who cannot use a managed service or require greater level of control of their cluster.\n• Gain 24/7 access to our Engineers for “third level” Cassandra support\n• Troubleshooting, advice, emergency response.\n• Consulting solutions\n• Data model design and/or review\n• Cluster design, sizing, performance testing and tuning\n• Training for developers and operational engineers\n• Find out more or start a free trial\n© DataStax, All Rights Reserved. 2\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-3-638.jpg?cb=1478206889\" title=\"“Globally unique perspective of Cassandra.”&#10;• Our customer ...\" target=\"_blank\">\n        3.\n      </a>\n    “Globally unique perspective of Cassandra.”\n• Our customer base:\n• Diverse. From early stage start-ups to large well-\nknown global enterprises.\n• Education, Retail, Marketing, Advertising, Finance,\nInsurance, Health, Social, Research\n• All use cases: Messaging, IoT, eCommerce, Analytics,\nRecommendations, Security.\n• Small development clusters to large scale production\ndeployments requiring 100% uptime.\n• Nodes under management:\n• 700+ active nodes under management,\n• All versions from Cassandra 2.0.11 - Cassandra 3.7\n© DataStax, All Rights Reserved. 3\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-4-638.jpg?cb=1478206889\" title=\"About Me&#10;Brooke Jensen&#10;VP Technical Operations, Customer Se...\" target=\"_blank\">\n        4.\n      </a>\n    About Me\nBrooke Jensen\nVP Technical Operations, Customer Services / Cassandra MVP\n• Previous: Senior Software Engineer, Instaclustr\n• Education: Bachelor Software Engineering\n• Life before Instaclustr:\n• 11+ years Software Engineering.\n• Specialized in performance optimization of large enterprise systems (e.g. Australian Customs, Taxation\nOffice, Department of Finance, Deutsche Bank)\n• Extensive experience managing and resolving major system incidents and outages.\n• Lives: Canberra, Au\n© DataStax, All Rights Reserved. 4\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-5-638.jpg?cb=1478206889\" title=\"Talk Overview&#10;• Collection of common problems we see and ma...\" target=\"_blank\">\n        5.\n      </a>\n    Talk Overview\n• Collection of common problems we see and manage on a daily basis.\n• Examples and war stories from the field.\n• HOWTOs, tips and tricks.\n• Covering:\n• Cluster Design\n• Managing compactions\n• Large partitions\n• Disk usage and management\n• Tombstones and Deletes\n• Common sense advice\n© DataStax, All Rights Reserved. 5\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-6-638.jpg?cb=1478206889\" title=\"Cluster Design Basics – Racks &amp; RF&#10;• For production we reco...\" target=\"_blank\">\n        6.\n      </a>\n    Cluster Design Basics – Racks &amp; RF\n• For production we recommend (minimum): 3 nodes in 3 racks with RF3.\n Make racks a multiple of RF.\n• Use logical racks and map to physical racks.\n• Each rack will contain a full copy of the data.\n• Can survive the loss of nodes without losing QUORUM (strong consistency)\n• Use NetworkTopologyStrategy. It’s not just for multi-DC, but is also “rack aware”\nALTER KEYSPACE &lt;keyspace&gt; WITH replication = {'class': 'NetworkTopologyStrategy','DC1': '3'}\n© DataStax, All Rights Reserved. 6\nGetting this right upfront will make\nmanagement of the cluster much\neasier in the future.\nR2\nR2\nR2\nR1\nR1\nR1\nR3\nR3\nR3\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-7-638.jpg?cb=1478206889\" title=\"The case for single racks&#10;• Datastax docs suggest not to us...\" target=\"_blank\">\n        7.\n      </a>\n    The case for single racks\n• Datastax docs suggest not to use racks?\n• “It’s hard to set up”\n• “Expanding is difficult” – not if using vnodes (default from 2.0.9)\n• Spending the time to set up is WORTH IT!\n• Minimizes downtime during upgrades and maintenance\n• Can perform upgrades/restarts rack-by-rack\n• Can (technically) lose a whole rack without downtime\n• We go one further and map racks to AWS AZ:\n© DataStax, All Rights Reserved. 7\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-8-638.jpg?cb=1478206889\" title=\"Setting it up&#10;yaml:&#10;endpoint_snitch: GossipingPropertyFileS...\" target=\"_blank\">\n        8.\n      </a>\n    Setting it up\nyaml:\nendpoint_snitch: GossipingPropertyFileSnitch\ncassandra-rackdc.properties:\nExecuting 'cat /etc/cassandra/cassandra-rackdc.properties' on 52.37.XXX.XXX\nHost 52.37.XXX.XXX response:\n#Generated by Instaclustr\n#Mon Mar 28 19:22:21 UTC 2016\ndc=US_WEST_2\nprefer_local=true\nrack=us-west-2b\n© DataStax, All Rights Reserved. 8\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-9-638.jpg?cb=1478206889\" title=\"Compactions – the basics&#10;© DataStax, All Rights Reserved. 1...\" target=\"_blank\">\n        9.\n      </a>\n    Compactions – the basics\n© DataStax, All Rights Reserved. 10\n• Regular compactions are an integral part of any healthy Cassandra cluster.\n• Occur periodically to purge tombstones, merge disparate row data into new SSTables to reclaim\ndisk space and keep read operations optimized.\n• Can have a significant disk, memory (GC), cpu, IO overhead.\n• Are often the cause of “unexplained” latency or IO issues in the cluster\n• Ideally, get the compaction strategy right at table creation time. You can change it later, but that\nmay force a re-write all of the data in that CF using the new Compaction Strategy\n• STCS – Insert heavy and general workloads\n• LCS – Read heavy workloads, or more updates than inserts\n• DTCS – Not where there are updates to old data or inserts that are out of order.\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-10-638.jpg?cb=1478206889\" title=\"Monitoring Compactions&#10;$ nodetool compactionstats -H&#10;pendin...\" target=\"_blank\">\n        10.\n      </a>\n    Monitoring Compactions\n$ nodetool compactionstats -H\npending tasks: 130\ncompaction type keyspace table completed total unit progress\nCompaction instametrics events_raw 1.35 GB 1.6 GB bytes 84.77%\nCompaction instametrics events_raw 1.28 GB 1.6 GB bytes 80.21%\nActive compaction remaining time : 0h00m33s\n• Not uncommon for large compactions to get “stuck” or fall behind.\n• On 2.0 in particular. Significantly improved in 2.1, even better in 3\n• A single node doing compactions can cause latency issues across\nthe whole cluster, as it will become slow to respond to queries.\n• Heap pressure will cause frequent flushing of Memtables to disk.\n=&gt; many small SSTables =&gt; many compactions\n© DataStax, All Rights Reserved. 11\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-11-638.jpg?cb=1478206889\" title=\"Compactions: other things to check&#10;© DataStax, All Rights R...\" target=\"_blank\">\n        11.\n      </a>\n    Compactions: other things to check\n© DataStax, All Rights Reserved. 12\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-12-638.jpg?cb=1478206889\" title=\"Managing Compactions&#10;Few things you can do if compactions a...\" target=\"_blank\">\n        12.\n      </a>\n    Managing Compactions\nFew things you can do if compactions are causing issues (e.g. latency)\nThrottle: nodetool setcompactionthroughput 16\nStop and disable : nodetool stop COMPACTION\nTake the node out (and unthrottle):\nnodetool disablebinary &amp;&amp; nodetool disablegossip &amp;&amp; nodetool disablethrift &amp;&amp; nodetool setcompactionthroughput 0\n© DataStax, All Rights Reserved. 13\nSet until C* is restarted. On 2.1 applies to NEW\ncompactions, on 2.2.5+ applies instantly\nOther nodes will mark this node as down,\nSo need to complete within HH window (3h)\nCase is important!\nStops currently active compactions only.\nCompaction starts\nNode taken out\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-13-638.jpg?cb=1478206889\" title=\"Large Partitions&#10;• One of the biggest problems we deal with...\" target=\"_blank\">\n        13.\n      </a>\n    Large Partitions\n• One of the biggest problems we deal with. Root cause of many other issues, and a PITA to manage.\n• We recommend to keep them 100MB or less.\nCreates issues with:\nCompactions\nIn 2.0, compactions of partitions &gt; 64MB were considerably slower. Partitions &gt;2GB often getting stuck.\nImproved in 2.1 and confirmed we observe less of these problems in upgraded clusters.\nAdding, replacing nodes – streaming will often fail.\nQuerying large partitions is considerably slower. The whole partition is stored on every replica node,\nleading to hotspots.\nCan be hard to get rid of.\n© DataStax, All Rights Reserved. 14\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-14-638.jpg?cb=1478206889\" title=\"Checking partition sizes&#10;~ $ nodetool cfstats -H keyspace.c...\" target=\"_blank\">\n        14.\n      </a>\n    Checking partition sizes\n~ $ nodetool cfstats -H keyspace.columnfamily\n…\nCompacted partition minimum bytes: 125 bytes\nCompacted partition maximum bytes: 11.51 GB\nCompacted partition mean bytes: 844 bytes\n$ nodetool cfhistograms keyspace columnfamily\nPercentile SSTables Write Latency Read Latency Partition Size Cell Count\n(micros) (micros) (bytes)\n50% 1.00 14.00 124.00 372 2\n75% 1.00 14.00 1916.00 372 2\n95% 3.00 24.00 17084.00 1597 12\n98% 4.00 35.00 17084.00 3311 24\n99% 5.00 50.00 20501.00 4768 42\nMin 0.00 4.00 51.00 125 0\nMax 5.00 446.00 20501.00 12359319162 129557750\n© DataStax, All Rights Reserved. 15\nHuge delta between 99th percentile and\nMax indicates most data (bytes) is in\none partition.\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-15-638.jpg?cb=1478206889\" title=\"Disk Usage&#10;• As a guide, maintain nodes under 70% (50% for ...\" target=\"_blank\">\n        15.\n      </a>\n    Disk Usage\n• As a guide, maintain nodes under 70% (50% for STCS).\n• At 80% take action.\n• Why so much headroom?\n• Compactions will cause a temporary increase in disk usage while both sets of SSTables exist, but\nonce complete will free up space that was occupied by old SSTables.\n• FYI, repair requests a snapshot before execution.\n• Recovering from a filled disk can be a pain, and you CAN LOSE DATA.\n• C* won’t start, for a start.\n• Nodes out of the cluster during recovery &gt;3 hours will require repair.\n© DataStax, All Rights Reserved. 16\nSep 08 05:38:15 cassandra[17118]: at java.lang.Thread.run(Thread.java:745) ~[na:1.8.0_91]\nSep 08 05:38:15 cassandra[17118]: Caused by: java.io.IOException: No configured data directory contains\nenough space to write 99 bytes\nSep 08 05:38:16 systemd[1]: cassandra.service: Main process exited, code=exited,\nSep 08 05:38:16 systemd[1]: cassandra.service: Unit entered failed state.\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-16-638.jpg?cb=1478206889\" title=\"Try this first: stop writing data.&#10;© DataStax, All Rights R...\" target=\"_blank\">\n        16.\n      </a>\n    Try this first: stop writing data.\n© DataStax, All Rights Reserved. 17\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-17-638.jpg?cb=1478206889\" title=\"Can’t stop? Won’t stop?&#10;Quick win: clearing snapshots.&#10;node...\" target=\"_blank\">\n        17.\n      </a>\n    Can’t stop? Won’t stop?\nQuick win: clearing snapshots.\nnodetool cfstats or nodetool listsnapshots will show if you have any snapshots to clear:\n© DataStax, All Rights Reserved. 18\nnodetool clearsnapshot\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-18-638.jpg?cb=1478206889\" title=\"Finding data to remove&#10;© DataStax, All Rights Reserved. 19&#10;...\" target=\"_blank\">\n        18.\n      </a>\n    Finding data to remove\n© DataStax, All Rights Reserved. 19\nI like to look at the data folders on disk – easier to identify than with cfstats.\nNote also: might not just be your data. Space can commonly be consumed by snapshots or even system keyspaces.\n• We’ve had nodes nearly fill up because of stored hints.\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-19-638.jpg?cb=1478206889\" title=\"Tip: Removing data&#10;© DataStax, All Rights Reserved. 20&#10;DELE...\" target=\"_blank\">\n        19.\n      </a>\n    Tip: Removing data\n© DataStax, All Rights Reserved. 20\nDELETE - creates tombstones which will not be purged by compactions until after gc_grace_seconds\n• Default is 10 days, but you can ALTER it and it is effective immediately.\n• Make sure all nodes are UP before changing gc_grace.\nTRUNCATE or DROP – only creates a snapshot as a backup before removing all the data.\n• The disk space is released as soon as the snapshot is cleared\n• Preferred where possible.\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-20-638.jpg?cb=1478206889\" title=\"Disk Usage – Other Actions to try&#10;• Add Nodes + run cleanup...\" target=\"_blank\">\n        20.\n      </a>\n    Disk Usage – Other Actions to try\n• Add Nodes + run cleanups\n• After all new nodes are running, run nodetool cleanup on each of the previously existing nodes to remove\nthe keys that no longer belong to those nodes.\n• If on AWS, add EBS (requires restart).\n• Disable autocompactions (will negatively effect read latency so not recommended)\n© DataStax, All Rights Reserved. 21\nTip: JOINING (adding) nodes\n• When you add nodes to a cluster, they will typically overstream data initially using more disk space than you expect. Duplicates will be\ncompacted away eventually.\n• Disable compaction throttling while the node is JOINING.\n• If streaming/joining fails and you have to restart it, the node will restream ALL SSTables again from the beginning, potentially filling up the\ndisks. ‘rm’ cassandra data folder before restarting.\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-21-638.jpg?cb=1478206889\" title=\"Compaction spikes&#10;• Compactions, particularly large ones, w...\" target=\"_blank\">\n        21.\n      </a>\n    Compaction spikes\n• Compactions, particularly large ones, will cause spikes in disk usage while both sets of SSTables\nexist.\n• Ideally, you want the compaction(s) to complete and free up space, but how can you assess\nwhether that is possible?\nUnlikely.\n© DataStax, All Rights Reserved. 22\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-22-638.jpg?cb=1478206889\" title=\"Compaction spikes&#10;1. Find the tmp SSTable associated with t...\" target=\"_blank\">\n        22.\n      </a>\n    Compaction spikes\n1. Find the tmp SSTable associated with the current compaction. From this, together with %\ncomplete in compactionstats you can get a feel for how much more space you need:\n$ -rw-r--r-- find /var/lib/cassandra/data/ -name \"*tmp*Data.db\" | xargs ls –lh\n1 root root 4.5G Sep 1 14:56 keyspace1/posts/keyspace1-posts-tmp-ka-118955-Data.db\n2. Keep a very close eye the disk, compaction and size of tmp file:\nwatch –n30 'df -h; ls -lh keyspace1-posts-tmp-ka-118955-Data.db; nodetool compactionstats –H’\nFilesystem Size Used Avail Use% Mounted on\n/dev/md127 787G 746G 506M 100% /var/lib/cassandra\n© DataStax, All Rights Reserved. 23\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-23-638.jpg?cb=1478206889\" title=\"Case study: Yesterday’s drama&#10;Scene:&#10;• 15 node production c...\" target=\"_blank\">\n        23.\n      </a>\n    Case study: Yesterday’s drama\nScene:\n• 15 node production cluster, 12 * m4xl-1600 nodes + 3 * m4xl-800 nodes (ie 3 with half storage)\n• Keyspace is RF 2 and application requires QUORUM\n• (sum_of_replication_factors / 2) + 1 = 2 (ie both replicas)\n• Therefore can’t take nodes out (or let them die) as it will cause application outage.\n• Peak processing time is 8am-6pm.\n• Need to keep the node up until the end of the day.\n• Write heavy workload\n© DataStax, All Rights Reserved. 24\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-24-638.jpg?cb=1478206889\" title=\"09:33:&#10;~ $ df –h&#10;Filesystem Size Used Avail Use% Mounted on...\" target=\"_blank\">\n        24.\n      </a>\n    09:33:\n~ $ df –h\nFilesystem Size Used Avail Use% Mounted on\n/dev/md127 787G 777G 10G 99% /var/lib/cassandra\n11:03:\nFilesystem Size Used Avail Use% Mounted on\n/dev/md127 787G 781G 5.9G 100% /var/lib/cassandra\n12:37:\n~ $ nodetool disableautocompaction\n~ $ df –h\nFilesystem Size Used Avail Use% Mounted on\n/dev/md127 787G 769G 18G 98% /var/lib/cassandra\n© DataStax, All Rights Reserved. 25\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-25-638.jpg?cb=1478206889\" title=\"© DataStax, All Rights Reserved. 26&#10;13:40:&#10;Filesystem Size ...\" target=\"_blank\">\n        25.\n      </a>\n    © DataStax, All Rights Reserved. 26\n13:40:\nFilesystem Size Used Avail Use% Mounted on\n/dev/md127 787G 785G 2G 100% /var/lib/cassandra\nCrap.\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-26-638.jpg?cb=1478206889\" title=\"Solution was to move one CF to EBS in the background before...\" target=\"_blank\">\n        26.\n      </a>\n    Solution was to move one CF to EBS in the background before the disk fills up.\n~ $ du -hs /var/lib/cassandra/data/prod/*\n89G /var/lib/cassandra/data/prod/cf-39153090119811e693793df4078eeb99\n38G /var/lib/cassandra/data/prod/cf_one_min-e17256f091a011e5a5c327b05b4cd3f4\n~ $ rsync -aOHh /var/lib/cassandra/data/prod/cf_one_min-e17256f091a011e5a5c327b05b4cd3f4 /mnt/ebs/\nMeanwhile:\nFilesystem Size Used Avail Use% Mounted on\n/dev/md127 787G 746G 906M 100% /var/lib/cassandra\n/dev/xvdp 79G 37G 39G 49% /mnt/ebs\nNow just mount bind it, and restart Cassandra:\n/dev/xvdp on /lib/cassandra/data/prod/cf_one_min-e17256f091a011e5a5c327b05b4cd3f4\n© DataStax, All Rights Reserved. 27\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-27-638.jpg?cb=1478206889\" title=\"Monitoring – how we detect problems&#10;• Client read and write...\" target=\"_blank\">\n        27.\n      </a>\n    Monitoring – how we detect problems\n• Client read and write latency\n• Local CF read and write latency\n• Number of reads or writes deviating from average\n• Outlier nodes\n• Down nodes\n• Disk usage\n• Pending compactions\n• Check for large partitions (data model issues)\n• In the logs:\n• Large batch warnings\n• Tombstone warnings\n• Excessive GC and/or long pauses\n© DataStax, All Rights Reserved. 28\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-28-638.jpg?cb=1478206889\" title=\"Case study: Don’t break your cluster.&#10;WARNING! It is possib...\" target=\"_blank\">\n        28.\n      </a>\n    Case study: Don’t break your cluster.\nWARNING! It is possible to get your cluster into a state from which you are unable to recover\nwithout significant downtime or data loss.\n© DataStax, All Rights Reserved. 29\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-29-638.jpg?cb=1478206889\" title=\"“This happened during normal operations at night, so I don'...\" target=\"_blank\">\n        29.\n      </a>\n    “This happened during normal operations at night, so I don't think any of us were doing anything\nabnormal. We've been doing some processing that creates pretty heavy load over the last few weeks...”\nOrly?\n© DataStax, All Rights Reserved. 30\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-30-638.jpg?cb=1478206889\" title=\"Unthrottled data load&#10;• Load average of 56, on 8 core machi...\" target=\"_blank\">\n        30.\n      </a>\n    Unthrottled data load\n• Load average of 56, on 8 core machines.\n• Nodes were saturated and exhausted heap space.\n• Regular GC pauses of 12000ms - 17000ms\n• Memtables are frequently flushed to disk.\n• This resulted in over 120,000 small SSTables being created on some nodes.\n• Data was spread across thousands of SSTables, so read latency skyrocketed.\n• Was using paxos writes (LWT), which require a read before every write. This caused writes to fail\nbecause as reads were timing out.\n• Compactions could not keep up, and added additional load to the already overloaded nodes.\n• C* eventually crashed on most nodes, leaving some corrupt SSTables.\n© DataStax, All Rights Reserved. 31\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-31-638.jpg?cb=1478206889\" title=\"17 second GC pauses. Nice.&#10;Aug 16 15:51:58 INFO o.a.cassand...\" target=\"_blank\">\n        31.\n      </a>\n    17 second GC pauses. Nice.\nAug 16 15:51:58 INFO o.a.cassandra.service.GCInspector ConcurrentMarkSweep GC in 12416ms. CMS\nOld Gen: 6442450872 -&gt; 6442450912; Par Eden Space: 1718091776 -&gt; 297543768; Par Survivor Space:\n214695856 -&gt; 0\nAug 16 15:52:20 INFO o.a.cassandra.service.GCInspector ConcurrentMarkSweep GC in 17732ms. CMS\nOld Gen: 6442450912 -&gt; 6442450864; Par Eden Space: 1718091776 -&gt; 416111040; Par Survivor Space:\n214671752 -&gt; 0\nHeap pressure causes C* to flush memtables to disk. This created &gt;120,000 Memtables on some\nnodes.\n 3+ days just to catch up on compactions, which were continually failing because of:\nAug 18 22:11:43 java.io.FileNotFoundException: /var/lib/cassandra/data/keyspace/cf-\nf4683d90f88111e586b7e962b0d85be3/keyspace-cf-ka-1243722-Data.db (Too many open files)\njava.lang.RuntimeException: java.io.FileNotFoundException: /var/lib/cassandra/data/keyspace/cf-\nf4683d90f88111e586b7e962b0d85be3/keyspace-cf-ka-1106806-Data.db (No such file or directory)\n© DataStax, All Rights Reserved. 32\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-32-638.jpg?cb=1478206889\" title=\"1. Once we got C* stable and caught up on compactions, ther...\" target=\"_blank\">\n        32.\n      </a>\n    1. Once we got C* stable and caught up on compactions, there were still corrupt SSTables present and\nnodes were in an inconsistent state.\n2. Couldn’t fix with repairs:\nERROR o.apache.cassandra.repair.Validator Failed creating a merkle tree for [repair #21be1ac0-6809-11e6-a098-\nb377cb035d78 on keyspace/cf, (-227556542627198517,-225096881583623998]], /52.XXX.XXX.XXX (see log for details)\nERROR o.a.c.service.CassandraDaemon Exception in thread Thread[ValidationExecutor:708,1,main]\njava.lang.NullPointerException: null\n3. Have deleted corrupt SSSTables on some nodes. This is ok, presume there are other copies of the data\nin the cluster. We’ll have to repair later.\n4. Run online scrubs on each node to identify corrupt SSTables, and fix (rewrite) where possible.\n5. For nodes where online scrub does not complete, take the node offline and attempt an offline scrub of\nidentified corrupt SSTables.\n6. If offline scrub fails to rewrite any SSTables a node, delete those remaining corrupt SSTables.\n7. Run a repair across the cluster to make data consistent across all nodes.\n@ 8th September, 3 weeks after the initial data load and the cluster is STILL in an inconsistent state\nwith corrupt SSTables and queries occasionally failing.\n© DataStax, All Rights Reserved. 33\nLong road to recovery\n \n  </li>\n  <li>\n      <a href=\"https://image.slidesharecdn.com/csummitlessonslearnedrunning1800clustersbrookejenseninstaclustr-160913040933/95/lessons-learned-from-running-1800-clusters-brooke-jensen-instaclustr-cassandra-summit-2016-33-638.jpg?cb=1478206889\" title=\"Some final tips&#10;• When making major changes to the cluster ...\" target=\"_blank\">\n        33.\n      </a>\n    Some final tips\n• When making major changes to the cluster (expanding, migrating, decomissioning), GO SLOW.\n• It takes longer to recover from errors than just doing it right the first time.\n• Things I’ve seen customers do:\n• Rebuild 16 nodes in a new DC concurrently\n• Decommission multiple nodes at once\n• Unthrrotled data loads\n• Keep C* up to date, but not too up to date.\n• 2.0 has troubles with large compactions\n• Currently investigating segfaults with MV in 3.7\n• Read the source code.\n• It is the most thorough and up to date documentation.\n© DataStax, All Rights Reserved. 34\n \n  </li>\n              </ol></div></div></div><aside id=\"side-panel\" class=\"small-12 large-4 columns j-related-more-tab\"><dl class=\"tabs related-tabs small\" data-tab=\"\"><dd class=\"active\">\n      <a href=\"#related-tab-content\" data-ga-cat=\"bigfoot_slideview\" data-ga-action=\"relatedslideshows_tab\">\n        Recommended\n      </a>\n    </dd>\n</dl><div class=\"tabs-content\"><ul id=\"related-tab-content\" class=\"content active no-bullet notranslate\"><li class=\"lynda-item\">\n  <a data-ssid=\"65959650\" title=\"Teaching Techniques: Creating Multimedia Learning\" href=\"https://www.linkedin.com/learning/teaching-techniques-creating-multimedia-learning?trk=slideshare_sv_learning\" data-ga-cat=\"sv_loggedout\" data-ga-label=\"lil_rec_Teaching Techniques: Creating Multimedia Learning\" data-ga-action=\"click\">\n    <div class=\"lynda-thumbnail\"><img class=\"j-thumbnail j-lazy-thumb\" alt=\"Teaching Techniques: Creating Multimedia Learning\" src=\"https://www.linkedin.com/media-proxy/ext?w=1200&amp;h=675&amp;hash=5yNrggG44Flut51QOcRX28HD9g0%3D&amp;ora=1%2CaFBCTXdkRmpGL2lvQUFBPQ%2CxAVta5g-0R6plxVUzgUv5K_PrkC9q0RIUJDPBy-iXSWq-dafY3HpecTcZLSioVsTfy8EkQ07eO6vRzjoG469LcLmY4Yx3A\" /></div>\n    <div class=\"lynda-content\"><p>Teaching Techniques: Creating Multimedia Learning</p><p>Online Course - LinkedIn Learning</p></div>\n  </a>\n</li>\n          <li class=\"lynda-item\">\n  <a data-ssid=\"65959650\" title=\"Teaching Future-Ready Students\" href=\"https://www.linkedin.com/learning/teaching-future-ready-students?trk=slideshare_sv_learning\" data-ga-cat=\"sv_loggedout\" data-ga-label=\"lil_rec_Teaching Future-Ready Students\" data-ga-action=\"click\">\n    <div class=\"lynda-thumbnail\"><img class=\"j-thumbnail j-lazy-thumb\" alt=\"Teaching Future-Ready Students\" src=\"https://www.linkedin.com/media-proxy/ext?w=1200&amp;h=675&amp;hash=l5Oo%2BC8xrExl1LjsAzoFgo7%2B9iA%3D&amp;ora=1%2CaFBCTXdkRmpGL2lvQUFBPQ%2CxAVta5g-0R6plxVUzgUv5K_PrkC9q0RIUJDPBy-lWiKq89OfZHbuec7ZZLSiol8eeywAlgEzfemtRDTpEo69LcLmY4Yx3A\" /></div>\n    <div class=\"lynda-content\"><p>Teaching Future-Ready Students</p><p>Online Course - LinkedIn Learning</p></div>\n  </a>\n</li>\n          <li class=\"lynda-item\">\n  <a data-ssid=\"65959650\" title=\"SMART Board Essential Training\" href=\"https://www.linkedin.com/learning/smart-board-essential-training?trk=slideshare_sv_learning\" data-ga-cat=\"sv_loggedout\" data-ga-label=\"lil_rec_SMART Board Essential Training\" data-ga-action=\"click\">\n    <div class=\"lynda-thumbnail\"><img class=\"j-thumbnail j-lazy-thumb\" alt=\"SMART Board Essential Training\" src=\"https://www.linkedin.com/media-proxy/ext?w=1200&amp;h=675&amp;hash=L8W%2BAILfUItMtiIFfmNzSmnQWEA%3D&amp;ora=1%2CaFBCTXdkRmpGL2lvQUFBPQ%2CxAVta5g-0R6plxVUzgUv5K_PrkC9q0RIUJDPBy-gXyGq_d2fYXPtecDXZLSioV8QfiwHlQIzfO6sQzToF469LcLmY4Yx3A\" /></div>\n    <div class=\"lynda-content\"><p>SMART Board Essential Training</p><p>Online Course - LinkedIn Learning</p></div>\n  </a>\n</li>\n        <li class=\"j-related-item\">\n  <a data-ssid=\"66112228\" data-algo-id=\"21\" data-source-name=\"BROWSEMAP\" data-source-model=\"21\" data-urn-type=\"Slideshow\" data-score=\"1\" class=\"j-related-impression slideview_related_item j-recommendation-tracking\" title=\"Cassandra Tuning - Above and Beyond (Matija Gobec, SmartCat) | Cassandra Summit 2016\" href=\"https://www.slideshare.net/DataStax/cassandra-tuning-above-and-beyond-matija-gobec-smartcat-cassandra-summit-2016\">\n    \n    <div class=\"related-content\"><p>Cassandra Tuning - Above and Beyond (Matija Gobec, SmartCat) | Cassandra Summ...</p><p>DataStax</p></div>\n  </a>\n</li>\n        <li class=\"j-related-item\">\n  <a data-ssid=\"63580578\" data-algo-id=\"21\" data-source-name=\"BROWSEMAP\" data-source-model=\"21\" data-urn-type=\"Slideshow\" data-score=\"1\" class=\"j-related-impression slideview_related_item j-recommendation-tracking\" title=\"Webinar: Top 5 Reasons Why DataStax Enterprise Is Game Changing For Architects\" href=\"https://www.slideshare.net/DataStax/webinar-top-5-reasons-why-datastax-enterprise-is-game-changing-for-architects\">\n    \n    <div class=\"related-content\"><p>Webinar: Top 5 Reasons Why DataStax Enterprise Is Game Changing For Architects</p><p>DataStax</p></div>\n  </a>\n</li>\n        <li class=\"j-related-item\">\n  <a data-ssid=\"14492284\" data-algo-id=\"21\" data-source-name=\"BROWSEMAP\" data-source-model=\"21\" data-urn-type=\"Slideshow\" data-score=\"1\" class=\"j-related-impression slideview_related_item j-recommendation-tracking\" title=\"strangeloop 2012 apache cassandra anti patterns\" href=\"https://www.slideshare.net/mattdennis/strangeloop-2012-apache-cassandra-anti-patterns\">\n    \n    <div class=\"related-content\"><p>strangeloop 2012 apache cassandra anti patterns</p><p>Matthew Dennis</p></div>\n  </a>\n</li>\n        <li class=\"j-related-item\">\n  <a data-ssid=\"33775630\" data-algo-id=\"21\" data-source-name=\"BROWSEMAP\" data-source-model=\"21\" data-urn-type=\"Slideshow\" data-score=\"1\" class=\"j-related-impression slideview_related_item j-recommendation-tracking\" title=\"How to size up an Apache Cassandra cluster (Training)\" href=\"https://www.slideshare.net/planetcassandra/201404-cluster-sizing\">\n    \n    <div class=\"related-content\"><p>How to size up an Apache Cassandra cluster (Training)</p><p>DataStax Academy</p></div>\n  </a>\n</li>\n        <li class=\"j-related-item\">\n  <a data-ssid=\"120740229\" data-algo-id=\"\" data-source-name=\"MORE_FROM_USER\" data-source-model=\"\" data-urn-type=\"Slideshow\" data-score=\"\" class=\"j-related-impression slideview_related_item j-recommendation-tracking\" title=\"Webinar: How Active Everywhere Database Architecture Accelerates Hybrid Cloud Deployments\" href=\"https://www.slideshare.net/DataStax/webinar-how-active-everywhere-database-architecture-accelerates-hybrid-cloud-deployments\">\n    \n    <div class=\"related-content\"><p>Webinar: How Active Everywhere Database Architecture Accelerates Hybrid Cloud...</p><p>DataStax</p></div>\n  </a>\n</li>\n        <li class=\"j-related-item\">\n  <a data-ssid=\"116307595\" data-algo-id=\"\" data-source-name=\"MORE_FROM_USER\" data-source-model=\"\" data-urn-type=\"Slideshow\" data-score=\"\" class=\"j-related-impression slideview_related_item j-recommendation-tracking\" title=\"Webinar  |  Aligning GDPR Requirements with Today's Hybrid Cloud Realities\" href=\"https://www.slideshare.net/DataStax/webinar-aligning-gdpr-requirements-with-todays-hybrid-cloud-realities\">\n    \n    <div class=\"related-content\"><p>Webinar  |  Aligning GDPR Requirements with Today's Hybrid Cloud Realities</p><p>DataStax</p></div>\n  </a>\n</li>\n        <li class=\"j-related-item\">\n  <a data-ssid=\"110183586\" data-algo-id=\"\" data-source-name=\"MORE_FROM_USER\" data-source-model=\"\" data-urn-type=\"Slideshow\" data-score=\"\" class=\"j-related-impression slideview_related_item j-recommendation-tracking\" title=\"Designing a Distributed Cloud Database for Dummies\" href=\"https://www.slideshare.net/DataStax/designing-a-distributed-cloud-database-for-dummies-110183586\">\n    \n    <div class=\"related-content\"><p>Designing a Distributed Cloud Database for Dummies</p><p>DataStax</p></div>\n  </a>\n</li>\n    </ul></div>\n    </aside></div></div><footer>\n          <div class=\"row\"><div class=\"columns\"><ul class=\"main-links text-center\"><li><a href=\"https://www.slideshare.net/about\">About</a></li>\n                \n                <li><a href=\"http://blog.slideshare.net/\">Blog</a></li>\n                <li><a href=\"https://www.slideshare.net/terms\">Terms</a></li>\n                <li><a href=\"https://www.slideshare.net/privacy\">Privacy</a></li>\n                <li><a href=\"http://www.linkedin.com/legal/copyright-policy\">Copyright</a></li>\n                \n              </ul></div></div>\n          \n          <div class=\"row\"><div class=\"columns\"><p class=\"copyright text-center\">LinkedIn Corporation © 2019</p></div></div>\n        </footer></div>\n    \n    <div class=\"modal_popup_container\"><div id=\"top-clipboards-modal\" class=\"reveal-modal xlarge top-clipboards-modal\" data-reveal=\"\" aria-labelledby=\"modal-title\" aria-hidden=\"true\" role=\"dialog\"><h4 class=\"modal-title\">Public clipboards featuring this slide</h4><hr /><p>No public clipboards found for this slide</p></div><div id=\"select-clipboard-modal\" class=\"reveal-modal medium\" data-reveal=\"\" aria-labelledby=\"modal-title\" aria-hidden=\"true\" role=\"dialog\" translate=\"no\"><p></p><h4 class=\"modal-title\">Select another clipboard</h4>\n    <hr /><a class=\"close-reveal-modal button-lrg\" href=\"#\" aria-label=\"Close\">×</a><div class=\"modal-content\"><div class=\"default-clipboard-panel radius\"><p>Looks like you’ve clipped this slide to <strong class=\"default-clipboard-title\"> already.</strong></p></div><div class=\"clipboard-list-container\"><div class=\"clipboard-create-new\"><p>Create a clipboard</p></div></div></div></div><div id=\"clipboard-create-modal\" class=\"reveal-modal medium\" data-reveal=\"\" aria-labelledby=\"modal-title\" aria-hidden=\"true\" role=\"dialog\" translate=\"no\"><p></p><h3>You just clipped your first slide!</h3>\n      \n        Clipping is a handy way to collect important slides you want to go back to later. Now customize the name of a clipboard to store your clips.<h4 class=\"modal-title\" id=\"modal-title\">\n    \n    <label>Description\n          \n        </label></h4></div>\n    <div class=\"row\"><label>Visibility\n        <small id=\"privacy-switch-description\">Others can see my Clipboard</small>\n          </label><label for=\"privacy-switch\">\n      </label></div>\n        \n    </div>\n    \n    \n    \n  \n    \n    \n  \n  \n  <noscript>\n    </noscript>"}}]}},"pageContext":{"alternative_id":13007}}