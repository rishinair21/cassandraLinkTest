{"data":{"allAnantCassandralinks":{"edges":[{"node":{"title":"Cassandra metrics and their use in Grafana","alternative_id":9257,"content":"<section class=\"section section--body section--first\"><div class=\"section-divider\"><hr class=\"section-divider\" /></div><div class=\"section-content\"><div class=\"section-inner sectionLayout--insetColumn\"><h1 id=\"63c7\" class=\"graf graf--h3 graf--leading graf--title\">Cassandra metrics and their use in Grafana</h1><p id=\"7a4d\" class=\"graf graf--p graf-after--h3\">During our adventure of adopting Cassandra for <a href=\"https://www.opera.com/computer/features/sync\" data-href=\"https://www.opera.com/computer/features/sync\" class=\"markup--anchor markup--p-anchor\" rel=\"nofollow noopener\" target=\"_blank\">sync feature</a> we’ve been hit by many things. Most of the time it was because we weren’t proficient with C* yet and equipped with detailed knowledge and experience in many areas related to it. Sometimes it also happened because of some nasty bugs either in our infrastructure or inside database itself.</p><p id=\"b9dd\" class=\"graf graf--p graf-after--p\">We would safe lots of energy and frustrating days at work having solid monitoring from the very beginning, allowing us to detect anomalies very early. Far too often we’re discovering metrics skyrocketing by running <a href=\"https://wiki.apache.org/cassandra/NodeTool\" data-href=\"https://wiki.apache.org/cassandra/NodeTool\" class=\"markup--anchor markup--p-anchor\" rel=\"nofollow noopener\" target=\"_blank\">nodetool</a> command during the work on usual tasks and not having proper charts with historic data. We’ve learned over time what to monitor and visualise so hopefully solution presented below will save lots of coffee and stress to anyone who’s seriously starting his journey with Cassandra. Many of changes we made to our monitoring infrastructure were dictated by incidents we had so this text is also a collection of our war stories. You can read about our infrastructure in previous posts:</p><ul class=\"postList\"><li id=\"9e0e\" class=\"graf graf--li graf-after--p\"><a href=\"http://medium.com/@mlowicki/statsd-centered-monitoring-setup-14d6eb391fcd\" data-href=\"http://medium.com/@mlowicki/statsd-centered-monitoring-setup-14d6eb391fcd\" class=\"markup--anchor markup--li-anchor\" target=\"_blank\">StatsD-centered monitoring setup</a></li><li id=\"38f7\" class=\"graf graf--li graf-after--li\"><a href=\"http://medium.com/@mlowicki/monitoring-cassandra-a7fde5b2de9c\" data-href=\"http://medium.com/@mlowicki/monitoring-cassandra-a7fde5b2de9c\" class=\"markup--anchor markup--li-anchor\" target=\"_blank\">Monitoring Cassandra</a></li><li id=\"ed23\" class=\"graf graf--li graf-after--li\"><a href=\"https://medium.com/@mlowicki/monitoring-cassandra-garbage-collector-83c8a515e403\" data-href=\"https://medium.com/@mlowicki/monitoring-cassandra-garbage-collector-83c8a515e403\" class=\"markup--anchor markup--li-anchor\" target=\"_blank\">Monitoring Cassandra garbage collector</a></li></ul><p id=\"5f9e\" class=\"graf graf--p graf-after--li\">Here I’ll focus on final output — charts in <a href=\"http://grafana.org\" data-href=\"http://grafana.org\" class=\"markup--anchor markup--p-anchor\" rel=\"nofollow noopener\" target=\"_blank\">Grafana</a> which is used extensively by us and is fed by couple of collecting tools of our choice. Till the end of this post I’ll omit prefix “sync.$environment.$datacenter.$host.” of each metric for readability.</p><p id=\"e5cb\" class=\"graf graf--p graf-after--p\">At the moment we’ve two major dashboards. First one called <a href=\"https://gist.github.com/mlowicki/304ecff7c35a99c46ef48e58bd271b57\" data-href=\"https://gist.github.com/mlowicki/304ecff7c35a99c46ef48e58bd271b57\" class=\"markup--anchor markup--p-anchor\" rel=\"nofollow noopener\" target=\"_blank\">“Sync database -general”</a> contains generic things not strictly related to Cassandra itself but required to spot anomalies related to slow disk I/O, network issues or CPU.</p><p id=\"d5fe\" class=\"graf graf--p graf-after--p\">Data are gathered mainly by <a href=\"http://github.com/python-diamond/Diamond\" data-href=\"http://github.com/python-diamond/Diamond\" class=\"markup--anchor markup--p-anchor\" rel=\"nofollow noopener\" target=\"_blank\">Diamond</a>.</p><h4 id=\"a5d1\" class=\"graf graf--h4 graf-after--p\">CPU</h4><figure id=\"91b6\" class=\"graf graf--figure graf-after--h4\"><div class=\"aspectRatioPlaceholder is-locked\"><div class=\"aspectRatioPlaceholder-fill\"><img class=\"graf-image\" data-image-id=\"1*7dCDUqQgWvT1vdYRb1KsoQ.png\" data-width=\"2500\" data-height=\"980\" data-action=\"zoom\" data-action-value=\"1*7dCDUqQgWvT1vdYRb1KsoQ.png\" src=\"https://cdn-images-1.medium.com/max/1600/1*7dCDUqQgWvT1vdYRb1KsoQ.png\" alt=\"image\" /></div></div></figure><figure id=\"6d4e\" class=\"graf graf--figure graf--iframe graf-after--figure\"><div class=\"aspectRatioPlaceholder is-locked\"><div class=\"aspectRatioPlaceholder-fill\"><div class=\"iframeContainer\"><iframe width=\"700\" height=\"250\" src=\"https://medium.com/media/b39583aad2051289dbf2c64cbb40aa91?postId=1f0dc33f9cca\" data-media-id=\"b39583aad2051289dbf2c64cbb40aa91\" allowfullscreen=\"allowfullscreen\" frameborder=\"0\">[embedded content]</iframe></div></div></div></figure><p id=\"f70c\" class=\"graf graf--p graf-after--figure\">Metrics are provided by <a href=\"http://diamond.readthedocs.org/en/latest/collectors/LoadAverageCollector/\" data-href=\"http://diamond.readthedocs.org/en/latest/collectors/LoadAverageCollector/\" class=\"markup--anchor markup--p-anchor\" rel=\"nofollow noopener\" target=\"_blank\">LoadAverageCollector</a>. On several occasions we get some old hanging processes so number of total and running processes could be useful.</p><h4 id=\"4c53\" class=\"graf graf--h4 graf-after--p\">Memory</h4><p id=\"d660\" class=\"graf graf--p graf-after--h4\">There were many memory leaks in 2.1.x branch (f.ex. <a href=\"https://issues.apache.org/jira/browse/CASSANDRA-9549\" data-href=\"https://issues.apache.org/jira/browse/CASSANDRA-9549\" class=\"markup--anchor markup--p-anchor\" rel=\"nofollow noopener\" target=\"_blank\">CASSANDRA-9549</a> or <a href=\"https://issues.apache.org/jira/browse/CASSANDRA-9681\" data-href=\"https://issues.apache.org/jira/browse/CASSANDRA-9681\" class=\"markup--anchor markup--p-anchor\" rel=\"nofollow noopener\" target=\"_blank\">CASSANDRA-9681</a>) so this one helps out to detect them:</p><pre id=\"0f56\" class=\"graf graf--pre graf-after--p\">gauges.memory.MemAvailable</pre><p id=\"ab5a\" class=\"graf graf--p graf-after--pre\">It’s important to not use <em class=\"markup--em markup--p-em\">MemFree</em> here which is something <a href=\"https://github.com/python-diamond/Diamond/issues/108\" data-href=\"https://github.com/python-diamond/Diamond/issues/108\" class=\"markup--anchor markup--p-anchor\" rel=\"nofollow noopener\" target=\"_blank\">very different</a> .</p><figure id=\"d8f8\" class=\"graf graf--figure graf-after--p\"><div class=\"aspectRatioPlaceholder is-locked\"><div class=\"aspectRatioPlaceholder-fill\"><img class=\"graf-image\" data-image-id=\"1*gijpkEzT-7X0hpbl75M_HA.png\" data-width=\"2500\" data-height=\"968\" data-action=\"zoom\" data-action-value=\"1*gijpkEzT-7X0hpbl75M_HA.png\" src=\"https://cdn-images-1.medium.com/max/1600/1*gijpkEzT-7X0hpbl75M_HA.png\" alt=\"image\" /></div></div></figure><h4 id=\"28a0\" class=\"graf graf--h4 graf-after--figure\">Network</h4><figure id=\"8e2f\" class=\"graf graf--figure graf-after--h4\"><div class=\"aspectRatioPlaceholder is-locked\"><div class=\"aspectRatioPlaceholder-fill\"><img class=\"graf-image\" data-image-id=\"1*oaT71TFhahjRMlsrdCNkiw.png\" data-width=\"2048\" data-height=\"898\" data-action=\"zoom\" data-action-value=\"1*oaT71TFhahjRMlsrdCNkiw.png\" src=\"https://cdn-images-1.medium.com/max/1600/1*oaT71TFhahjRMlsrdCNkiw.png\" alt=\"image\" /></div></div></figure><p id=\"7e7d\" class=\"graf graf--p graf-after--figure\">We’ve there f.ex:</p><figure id=\"f958\" class=\"graf graf--figure graf--iframe graf-after--p\"><div class=\"aspectRatioPlaceholder is-locked\"><div class=\"aspectRatioPlaceholder-fill\"><div class=\"iframeContainer\"><iframe width=\"700\" height=\"250\" src=\"https://medium.com/media/50e084c1d1fa38589524e84720129dea?postId=1f0dc33f9cca\" data-media-id=\"50e084c1d1fa38589524e84720129dea\" allowfullscreen=\"allowfullscreen\" frameborder=\"0\">[embedded content]</iframe></div></div></div></figure><p id=\"b9f6\" class=\"graf graf--p graf-after--figure\">and similar for transferred data (tx_byte, tx_errors, …) handy to debug things together with NetOps team.</p><h4 id=\"80de\" class=\"graf graf--h4 graf-after--p\">Disks</h4><figure id=\"a401\" class=\"graf graf--figure graf-after--h4\"><div class=\"aspectRatioPlaceholder is-locked\"><div class=\"aspectRatioPlaceholder-fill\"><img class=\"graf-image\" data-image-id=\"1*lo2Zo6mWtHkXeup_eOYTag.png\" data-width=\"2048\" data-height=\"922\" data-action=\"zoom\" data-action-value=\"1*lo2Zo6mWtHkXeup_eOYTag.png\" src=\"https://cdn-images-1.medium.com/max/1600/1*lo2Zo6mWtHkXeup_eOYTag.png\" alt=\"image\" /></div></div></figure><p id=\"5042\" class=\"graf graf--p graf-after--figure\">This is quite large group (row) but really helpful in making sure our SSD disks are behaving well and aren’t saturated. It contains metrics like:</p><figure id=\"400f\" class=\"graf graf--figure graf--iframe graf-after--p\"><div class=\"aspectRatioPlaceholder is-locked\"><div class=\"aspectRatioPlaceholder-fill\"><div class=\"iframeContainer\"><iframe width=\"700\" height=\"250\" src=\"https://medium.com/media/b87f5d8694c7ac9c894d570eeff195b6?postId=1f0dc33f9cca\" data-media-id=\"b87f5d8694c7ac9c894d570eeff195b6\" allowfullscreen=\"allowfullscreen\" frameborder=\"0\">[embedded content]</iframe></div></div></div></figure><p id=\"871d\" class=\"graf graf--p graf-after--figure\">provided by Diamond’s <a href=\"http://diamond.readthedocs.org/en/latest/collectors/DiskUsageCollector/\" data-href=\"http://diamond.readthedocs.org/en/latest/collectors/DiskUsageCollector/\" class=\"markup--anchor markup--p-anchor\" rel=\"nofollow noopener\" target=\"_blank\">DiskUsageCollector</a>.</p><h4 id=\"b846\" class=\"graf graf--h4 graf-after--p\">StatsD</h4><figure id=\"5c47\" class=\"graf graf--figure graf-after--h4\"><div class=\"aspectRatioPlaceholder is-locked\"><div class=\"aspectRatioPlaceholder-fill\"><img class=\"graf-image\" data-image-id=\"1*PuTkol6xQmSUEONzGjbGiA.png\" data-width=\"2512\" data-height=\"456\" data-action=\"zoom\" data-action-value=\"1*PuTkol6xQmSUEONzGjbGiA.png\" src=\"https://cdn-images-1.medium.com/max/1600/1*PuTkol6xQmSUEONzGjbGiA.png\" alt=\"image\" /></div></div></figure><p id=\"5816\" class=\"graf graf--p graf-after--figure\">To immediately see if everything is fine with StatsD daemon, number of metrics seems reasonable and that process is handling them in rational time we’re using two simple metrics sent automatically:</p><pre id=\"51b5\" class=\"graf graf--pre graf-after--p\">statsd.numStats<br />statsd.processing_time</pre><p id=\"6053\" class=\"graf graf--p graf-after--pre graf--trailing\">Useful to verify that everything works fine after upgrade.</p></div></div></section><section class=\"section section--body\"><div class=\"section-divider\"><hr class=\"section-divider\" /></div><div class=\"section-content\"><div class=\"section-inner sectionLayout--insetColumn\"><p id=\"d5c3\" class=\"graf graf--p graf--leading\">The second dashboard <a href=\"https://gist.github.com/mlowicki/e6aa3804ac2098082c692288f134554e\" data-href=\"https://gist.github.com/mlowicki/e6aa3804ac2098082c692288f134554e\" class=\"markup--anchor markup--p-anchor\" rel=\"nofollow noopener\" target=\"_blank\">“Sync — Cassandra”</a> is purely about Cassandra and it was built over time while learning about new places worth to monitor or when we had suspicion that particular component isn’t working as it should.</p><h4 id=\"c2a7\" class=\"graf graf--h4 graf-after--p\">Compaction</h4><p id=\"5f69\" class=\"graf graf--p graf-after--h4\">This one is about SSTables and compaction process. It’s important to know early if compaction stuck on certain node(s), number of pending tasks is growing or SSTables count exploded. We had such incidents in the past and detecting it early or even discovering it at all saved us headaches and allowed to react quickly.</p><figure id=\"99fc\" class=\"graf graf--figure graf-after--p\"><div class=\"aspectRatioPlaceholder is-locked\"><div class=\"aspectRatioPlaceholder-fill\"><img class=\"graf-image\" data-image-id=\"1*2Z_aVqjIZ6W6eEhg3ImTbw.png\" data-width=\"2048\" data-height=\"1054\" data-action=\"zoom\" data-action-value=\"1*2Z_aVqjIZ6W6eEhg3ImTbw.png\" src=\"https://cdn-images-1.medium.com/max/1600/1*2Z_aVqjIZ6W6eEhg3ImTbw.png\" alt=\"image\" /></div></div></figure><figure id=\"8e63\" class=\"graf graf--figure graf--iframe graf-after--figure\"><div class=\"aspectRatioPlaceholder is-locked\"><div class=\"aspectRatioPlaceholder-fill\"><div class=\"iframeContainer\"><iframe width=\"700\" height=\"250\" src=\"https://medium.com/media/65826272b139587848c6d332a0a1246d?postId=1f0dc33f9cca\" data-media-id=\"65826272b139587848c6d332a0a1246d\" allowfullscreen=\"allowfullscreen\" frameborder=\"0\">[embedded content]</iframe></div></div></div></figure><h4 id=\"1198\" class=\"graf graf--h4 graf-after--figure\">Compacting large partitions</h4><figure id=\"779e\" class=\"graf graf--figure graf-after--h4\"><div class=\"aspectRatioPlaceholder is-locked\"><div class=\"aspectRatioPlaceholder-fill\"><img class=\"graf-image\" data-image-id=\"1*GJxyB8GyUzkFWipKgm2ERQ.png\" data-width=\"1041\" data-height=\"475\" data-action=\"zoom\" data-action-value=\"1*GJxyB8GyUzkFWipKgm2ERQ.png\" src=\"https://cdn-images-1.medium.com/max/1600/1*GJxyB8GyUzkFWipKgm2ERQ.png\" alt=\"image\" /></div></div></figure><p id=\"fa9f\" class=\"graf graf--p graf-after--figure\">C* logs warnings while compacting partition longer than <em class=\"markup--em markup--p-em\">compaction_large_partition_warning_threshold_mb</em> (<a href=\"https://docs.datastax.com/en/cassandra/3.x/cassandra/configuration/configCassandra_yaml.html\" data-href=\"https://docs.datastax.com/en/cassandra/3.x/cassandra/configuration/configCassandra_yaml.html\" class=\"markup--anchor markup--p-anchor\" rel=\"nofollow noopener\" target=\"_blank\">cassandra.yaml</a>). We’re using <a href=\"https://medium.com/@mlowicki/monitoring-cassandra-garbage-collector-83c8a515e403#.4s2h29v6u\" data-href=\"https://medium.com/@mlowicki/monitoring-cassandra-garbage-collector-83c8a515e403#.4s2h29v6u\" class=\"markup--anchor markup--p-anchor\" target=\"_blank\">Logstash</a> to parse these warnings and put into StatsD. Lots of such events with high numbers may indicate problems with schema.</p><p id=\"5a73\" class=\"graf graf--p graf-after--p\">Two charts at the bottom are specific to our project where we’ve a concept of data type used a part of <a href=\"http://docs.datastax.com/en/cql/3.1/cql/cql_reference/refCompositePk.html\" data-href=\"http://docs.datastax.com/en/cql/3.1/cql/cql_reference/refCompositePk.html\" class=\"markup--anchor markup--p-anchor\" rel=\"nofollow noopener\" target=\"_blank\">composite partition key</a>.</p><h4 id=\"2aa9\" class=\"graf graf--h4 graf-after--p\">Disk</h4><figure id=\"f630\" class=\"graf graf--figure graf-after--h4\"><div class=\"aspectRatioPlaceholder is-locked\"><div class=\"aspectRatioPlaceholder-fill\"><img class=\"graf-image\" data-image-id=\"1*mm9zSbdaunNEp1JRZFcUBQ.png\" data-width=\"2504\" data-height=\"1252\" data-action=\"zoom\" data-action-value=\"1*mm9zSbdaunNEp1JRZFcUBQ.png\" src=\"https://cdn-images-1.medium.com/max/1600/1*mm9zSbdaunNEp1JRZFcUBQ.png\" alt=\"image\" /></div></div></figure><p id=\"7328\" class=\"graf graf--p graf-after--figure\">Cassandra provides also data about read / write latency:</p><figure id=\"2831\" class=\"graf graf--figure graf--iframe graf-after--p\"><div class=\"aspectRatioPlaceholder is-locked\"><div class=\"aspectRatioPlaceholder-fill\"><div class=\"iframeContainer\"><iframe width=\"700\" height=\"250\" src=\"https://medium.com/media/35adf3886c488d21b0cdbf3c38ad3b14?postId=1f0dc33f9cca\" data-media-id=\"35adf3886c488d21b0cdbf3c38ad3b14\" allowfullscreen=\"allowfullscreen\" frameborder=\"0\">[embedded content]</iframe></div></div></div></figure><p id=\"17ad\" class=\"graf graf--p graf--startsWithDoubleQuote graf-after--figure\">“Scanned tombstones” is fed by parsing C* logs and getting warnings about scanning large number of tombstones.</p><h4 id=\"9684\" class=\"graf graf--h4 graf-after--p\">Requests</h4><figure id=\"78d4\" class=\"graf graf--figure graf-after--h4\"><div class=\"aspectRatioPlaceholder is-locked\"><div class=\"aspectRatioPlaceholder-fill\"><img class=\"graf-image\" data-image-id=\"1*pHKYWPTXUHB1_LNW_uCy2Q.png\" data-width=\"2048\" data-height=\"1002\" data-action=\"zoom\" data-action-value=\"1*pHKYWPTXUHB1_LNW_uCy2Q.png\" src=\"https://cdn-images-1.medium.com/max/1600/1*pHKYWPTXUHB1_LNW_uCy2Q.png\" alt=\"image\" /></div></div></figure><figure id=\"caba\" class=\"graf graf--figure graf--iframe graf-after--figure\"><div class=\"aspectRatioPlaceholder is-locked\"><div class=\"aspectRatioPlaceholder-fill\"><div class=\"iframeContainer\"><iframe width=\"700\" height=\"250\" src=\"https://medium.com/media/4e2c1b3adedece7dec69e705b9107dc7?postId=1f0dc33f9cca\" data-media-id=\"4e2c1b3adedece7dec69e705b9107dc7\" allowfullscreen=\"allowfullscreen\" frameborder=\"0\">[embedded content]</iframe></div></div></div></figure><h4 id=\"ecfa\" class=\"graf graf--h4 graf-after--figure\">Errors</h4><figure id=\"6fe7\" class=\"graf graf--figure graf-after--h4\"><div class=\"aspectRatioPlaceholder is-locked\"><div class=\"aspectRatioPlaceholder-fill\"><img class=\"graf-image\" data-image-id=\"1*uGxgHatUTa628LXqPm992Q.png\" data-width=\"2048\" data-height=\"373\" data-action=\"zoom\" data-action-value=\"1*uGxgHatUTa628LXqPm992Q.png\" src=\"https://cdn-images-1.medium.com/max/1600/1*uGxgHatUTa628LXqPm992Q.png\" alt=\"image\" /></div></div></figure><figure id=\"e6dd\" class=\"graf graf--figure graf--iframe graf-after--figure\"><div class=\"aspectRatioPlaceholder is-locked\"><div class=\"aspectRatioPlaceholder-fill\"><div class=\"iframeContainer\"><iframe width=\"700\" height=\"250\" src=\"https://medium.com/media/db73c0f8ae52c67f9d5eee521f7c8224?postId=1f0dc33f9cca\" data-media-id=\"db73c0f8ae52c67f9d5eee521f7c8224\" allowfullscreen=\"allowfullscreen\" frameborder=\"0\">[embedded content]</iframe></div></div></div></figure><p id=\"2765\" class=\"graf graf--p graf-after--figure\">These two accumulative metrics (use <em class=\"markup--em markup--p-em\">perSecond</em> to get number of occurrences per second) show if either C* throws many exceptions and would be good to grep through its system.log or it can’t connect to other nodes which might be a sign of overloaded node(s) or network issues.</p><h4 id=\"efe3\" class=\"graf graf--h4 graf-after--p\">Thread pools</h4><figure id=\"52a4\" class=\"graf graf--figure graf-after--h4\"><div class=\"aspectRatioPlaceholder is-locked\"><div class=\"aspectRatioPlaceholder-fill\"><img class=\"graf-image\" data-image-id=\"1*NtwnlNlTD1e8Rebd1SvcxA.png\" data-width=\"2520\" data-height=\"1208\" data-action=\"zoom\" data-action-value=\"1*NtwnlNlTD1e8Rebd1SvcxA.png\" src=\"https://cdn-images-1.medium.com/max/1600/1*NtwnlNlTD1e8Rebd1SvcxA.png\" alt=\"image\" /></div></div></figure><p id=\"7b15\" class=\"graf graf--p graf-after--figure\">This might seem overwhelming but shows what threads are doing like creating Merkle trees (<em class=\"markup--em markup--p-em\">ValidationExecutor</em>), compacting (<em class=\"markup--em markup--p-em\">CompactionExecutor</em>) or just handling read requests.</p><figure id=\"e1b1\" class=\"graf graf--figure graf--iframe graf-after--p\"><div class=\"aspectRatioPlaceholder is-locked\"><div class=\"aspectRatioPlaceholder-fill\"><div class=\"iframeContainer\"><iframe width=\"700\" height=\"250\" src=\"https://medium.com/media/fedc0ef06e91c7ef94cfd56d3eff375e?postId=1f0dc33f9cca\" data-media-id=\"fedc0ef06e91c7ef94cfd56d3eff375e\" allowfullscreen=\"allowfullscreen\" frameborder=\"0\">[embedded content]</iframe></div></div></div></figure><h4 id=\"ffde\" class=\"graf graf--h4 graf-after--figure\">Key cache</h4><figure id=\"9285\" class=\"graf graf--figure graf-after--h4\"><div class=\"aspectRatioPlaceholder is-locked\"><div class=\"aspectRatioPlaceholder-fill\"><img class=\"graf-image\" data-image-id=\"1*-laQNkzg6iDLLUCR-P048w.png\" data-width=\"2530\" data-height=\"976\" data-action=\"zoom\" data-action-value=\"1*-laQNkzg6iDLLUCR-P048w.png\" src=\"https://cdn-images-1.medium.com/max/1600/1*-laQNkzg6iDLLUCR-P048w.png\" alt=\"image\" /></div></div></figure><p id=\"6acf\" class=\"graf graf--p graf-after--figure\">We don’t have hot data in Sync so row cache is disabled (<em class=\"markup--em markup--p-em\">row_cache_size_in_mb</em> set to 0 in cassandra.yaml<em class=\"markup--em markup--p-em\">)</em> but having charts for key cache to monitor its performance is precaution to save our time in the future.</p><figure id=\"f176\" class=\"graf graf--figure graf--iframe graf-after--p\"><div class=\"aspectRatioPlaceholder is-locked\"><div class=\"aspectRatioPlaceholder-fill\"><div class=\"iframeContainer\"><iframe width=\"700\" height=\"250\" src=\"https://medium.com/media/8c738888a683bcd2456f6c1d06a8c102?postId=1f0dc33f9cca\" data-media-id=\"8c738888a683bcd2456f6c1d06a8c102\" data-thumbnail=\"https://i.embed.ly/1/image?url=https%3A%2F%2Favatars2.githubusercontent.com%2Fu%2F97633%3Fv%3D3%26s%3D400&amp;key=4fce0568f2ce49e8b54624ef71a8a5bd\" allowfullscreen=\"allowfullscreen\" frameborder=\"0\">[embedded content]</iframe></div></div></div></figure><p id=\"c01b\" class=\"graf graf--p graf-after--figure\">Be careful with metrics ending with “.Value”. They hold accumulative values since node’s start so use <em class=\"markup--em markup--p-em\">perSecond</em> function to get rate per second.</p><p id=\"eaf4\" class=\"graf graf--p graf-after--p\"><em class=\"markup--em markup--p-em\">HitRate</em> might seem redundant if Graphite has <a href=\"http://graphite.readthedocs.org/en/1.0/functions.html#graphite.render.functions.asPercent\" data-href=\"http://graphite.readthedocs.org/en/1.0/functions.html#graphite.render.functions.asPercent\" class=\"markup--anchor markup--p-anchor\" rel=\"nofollow noopener\" target=\"_blank\">asPercent</a> but we can’t use it now because of <a href=\"https://github.com/graphite-project/graphite-web/issues/207\" data-href=\"https://github.com/graphite-project/graphite-web/issues/207\" class=\"markup--anchor markup--p-anchor\" rel=\"nofollow noopener\" target=\"_blank\">#207</a> which seems abandoned…</p><h4 id=\"fd37\" class=\"graf graf--h4 graf-after--p\">Memtables</h4><p id=\"ee46\" class=\"graf graf--p graf-after--h4\">There are couple of options in cassandra.yaml to tune M<a href=\"https://wiki.apache.org/cassandra/MemtableSSTable\" data-href=\"https://wiki.apache.org/cassandra/MemtableSSTable\" class=\"markup--anchor markup--p-anchor\" rel=\"nofollow noopener\" target=\"_blank\">emtables</a> (like <em class=\"markup--em markup--p-em\">memtable_cleanup_threshold</em> or <em class=\"markup--em markup--p-em\">memtable_flush_writers</em>) and this row will help you to discover eventual issues. We didn’t have any incidents with this part but always better to have such charts ready. Memtables are created per-ColumnFamily but for now we’re using aggregated metrics:</p><figure id=\"2a22\" class=\"graf graf--figure graf--iframe graf-after--p\"><div class=\"aspectRatioPlaceholder is-locked\"><div class=\"aspectRatioPlaceholder-fill\"><div class=\"iframeContainer\"><iframe width=\"700\" height=\"250\" src=\"https://medium.com/media/76721f1696ab644cce734cbff016f07c?postId=1f0dc33f9cca\" data-media-id=\"76721f1696ab644cce734cbff016f07c\" allowfullscreen=\"allowfullscreen\" frameborder=\"0\">[embedded content]</iframe></div></div></div></figure><h4 id=\"3ae5\" class=\"graf graf--h4 graf-after--figure\">Bloom filter</h4><figure id=\"b986\" class=\"graf graf--figure graf-after--h4\"><div class=\"aspectRatioPlaceholder is-locked\"><div class=\"aspectRatioPlaceholder-fill\"><img class=\"graf-image\" data-image-id=\"1*Kj-OQ8KH2q3giRNyOWKQyA.png\" data-width=\"2048\" data-height=\"715\" data-action=\"zoom\" data-action-value=\"1*Kj-OQ8KH2q3giRNyOWKQyA.png\" src=\"https://cdn-images-1.medium.com/max/1600/1*Kj-OQ8KH2q3giRNyOWKQyA.png\" alt=\"image\" /></div></div></figure><p id=\"0237\" class=\"graf graf--p graf-after--figure\">Added for the future (didn’t have any problems with this component so far) but we’re planning to tune <em class=\"markup--em markup--p-em\">bloom_filter_fp_chance</em> soon so will be used to get feedback after scheduled changes.</p><figure id=\"800c\" class=\"graf graf--figure graf--iframe graf-after--p\"><div class=\"aspectRatioPlaceholder is-locked\"><div class=\"aspectRatioPlaceholder-fill\"><div class=\"iframeContainer\"><iframe width=\"700\" height=\"250\" src=\"https://medium.com/media/d1c6f1806e9cdd50c62e70264e53212a?postId=1f0dc33f9cca\" data-media-id=\"d1c6f1806e9cdd50c62e70264e53212a\" allowfullscreen=\"allowfullscreen\" frameborder=\"0\">[embedded content]</iframe></div></div></div></figure><h4 id=\"7245\" class=\"graf graf--h4 graf-after--figure\">Snapshosts</h4><pre id=\"e290\" class=\"graf graf--pre graf-after--h4\">gauges.cassandra.jmx.org.apache.cassandra.metrics.ColumnFamily.SnapshotsSize.Value</pre><p id=\"166c\" class=\"graf graf--p graf-after--pre\">This single metrics is used to immediately see if <em class=\"markup--em markup--p-em\">`nodetool clearsnapshot`</em> can be fired to save significant disk space.</p><h4 id=\"e0da\" class=\"graf graf--h4 graf-after--p\">Hints</h4><figure id=\"0ad5\" class=\"graf graf--figure graf--iframe graf-after--h4\"><div class=\"aspectRatioPlaceholder is-locked\"><div class=\"aspectRatioPlaceholder-fill\"><div class=\"iframeContainer\"><iframe width=\"700\" height=\"250\" src=\"https://medium.com/media/c09b8fd20aef20d76ae3b6eeac0c6def?postId=1f0dc33f9cca\" data-media-id=\"c09b8fd20aef20d76ae3b6eeac0c6def\" allowfullscreen=\"allowfullscreen\" frameborder=\"0\">[embedded content]</iframe></div></div></div></figure><p id=\"e28d\" class=\"graf graf--p graf-after--figure\">Accumulative metrics to show hints across cluster.</p><h4 id=\"cb03\" class=\"graf graf--h4 graf-after--p\">Streams</h4><figure id=\"88d4\" class=\"graf graf--figure graf-after--h4\"><div class=\"aspectRatioPlaceholder is-locked\"><div class=\"aspectRatioPlaceholder-fill\"><img class=\"graf-image\" data-image-id=\"1*nIX2FE8jIgy4teHVoVixhg.png\" data-width=\"2048\" data-height=\"371\" data-action=\"zoom\" data-action-value=\"1*nIX2FE8jIgy4teHVoVixhg.png\" src=\"https://cdn-images-1.medium.com/max/1600/1*nIX2FE8jIgy4teHVoVixhg.png\" alt=\"image\" /></div></div></figure><figure id=\"0df9\" class=\"graf graf--figure graf--iframe graf-after--figure\"><div class=\"aspectRatioPlaceholder is-locked\"><div class=\"aspectRatioPlaceholder-fill\"><div class=\"iframeContainer\"><iframe width=\"700\" height=\"250\" src=\"https://medium.com/media/0a91777e498552cf4377ea4150c5581b?postId=1f0dc33f9cca\" data-media-id=\"0a91777e498552cf4377ea4150c5581b\" allowfullscreen=\"allowfullscreen\" frameborder=\"0\">[embedded content]</iframe></div></div></div></figure><p id=\"d73d\" class=\"graf graf--p graf-after--figure\">This part is used to see how nodes are busy with streaming operations.</p><h4 id=\"3223\" class=\"graf graf--h4 graf-after--p\">Connected clients</h4><figure id=\"c66a\" class=\"graf graf--figure graf--iframe graf-after--h4\"><div class=\"aspectRatioPlaceholder is-locked\"><div class=\"aspectRatioPlaceholder-fill\"><div class=\"iframeContainer\"><iframe width=\"700\" height=\"250\" src=\"https://medium.com/media/60ca814628287dda3704cba61b5ffb1a?postId=1f0dc33f9cca\" data-media-id=\"60ca814628287dda3704cba61b5ffb1a\" allowfullscreen=\"allowfullscreen\" frameborder=\"0\">[embedded content]</iframe></div></div></div></figure><p id=\"f566\" class=\"graf graf--p graf-after--figure graf--trailing\">It happens (usually while restarts) that binary or thrift protocol suddenly stops to work (or isn’t started) or number of connected clients isn’t balanced. This group will tell us if something like that takes place.</p></div></div></section><section class=\"section section--body section--last\"><div class=\"section-divider\"><hr class=\"section-divider\" /></div><div class=\"section-content\"><div class=\"section-inner sectionLayout--insetColumn\"><p id=\"3228\" class=\"graf graf--p graf--leading\">Most metrics we use are calculated per C* node basis. We don’t host multiple keyspaces per cluster and having charts per table wasn’t useful yet. Fortunately it’s a matter of modifying configuration file for <a href=\"https://jolokia.org\" data-href=\"https://jolokia.org\" class=\"markup--anchor markup--p-anchor\" rel=\"nofollow noopener\" target=\"_blank\">Jolokia</a> (through <a href=\"https://github.com/python-diamond/Diamond/blob/master/src/collectors/jolokia/cassandra_jolokia.py\" data-href=\"https://github.com/python-diamond/Diamond/blob/master/src/collectors/jolokia/cassandra_jolokia.py\" class=\"markup--anchor markup--p-anchor\" rel=\"nofollow noopener\" target=\"_blank\">CassandraJolokia</a> collector) and run Puppet which eventually restarts Diamond’s collectors.</p><p id=\"2bcf\" class=\"graf graf--p graf-after--p graf--trailing\">Our <a href=\"https://gist.github.com/mlowicki/95bd388ccd717fe305a1fcb693fa8fc3\" data-href=\"https://gist.github.com/mlowicki/95bd388ccd717fe305a1fcb693fa8fc3\" class=\"markup--anchor markup--p-anchor\" rel=\"nofollow noopener\" target=\"_blank\">Jolokia configuration file</a> became very long at some point so using regexps alleviate this problem a bit.</p></div></div></section>"}}]}},"pageContext":{"alternative_id":9257}}