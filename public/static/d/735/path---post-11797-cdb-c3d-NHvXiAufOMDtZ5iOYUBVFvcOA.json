{"data":{"allAnantCassandralinks":{"edges":[{"node":{"title":"smartcat-labs/cassandra-diagnostics","alternative_id":11797,"content":"<article class=\"markdown-body entry-content\" itemprop=\"text\">\n<p>Monitoring and audit power kit for Apache Cassandra.</p>\n<p><a href=\"https://travis-ci.org/smartcat-labs/cassandra-diagnostics\" rel=\"nofollow\"><img src=\"https://camo.githubusercontent.com/76a416d18123babf572d1379913c56645af9672f/68747470733a2f2f7472617669732d63692e6f72672f736d6172746361742d6c6162732f63617373616e6472612d646961676e6f73746963732e7376673f6272616e63683d6d6173746572\" alt=\"Build Status\" data-canonical-src=\"https://travis-ci.org/smartcat-labs/cassandra-diagnostics.svg?branch=master\" /></a>\n<a href=\"https://maven-badges.herokuapp.com/maven-central/io.smartcat/cassandra-diagnostics/\" rel=\"nofollow\"><img src=\"https://camo.githubusercontent.com/b2f836e75fad32d5b5e32102a53017aae8c71a64/68747470733a2f2f6d6176656e2d6261646765732e6865726f6b756170702e636f6d2f6d6176656e2d63656e7472616c2f696f2e736d6172746361742f63617373616e6472612d646961676e6f73746963732f62616467652e737667\" alt=\"Maven Central\" data-canonical-src=\"https://maven-badges.herokuapp.com/maven-central/io.smartcat/cassandra-diagnostics/badge.svg\" /></a>\n<a href=\"https://bintray.com/smartcat-labs/maven/cassandra-diagnostics/_latestVersion\" rel=\"nofollow\"><img src=\"https://camo.githubusercontent.com/c32ac0c09babdcfc567b7c56d8980e56ce5833f8/68747470733a2f2f6170692e62696e747261792e636f6d2f7061636b616765732f736d6172746361742d6c6162732f6d6176656e2f63617373616e6472612d646961676e6f73746963732f696d616765732f646f776e6c6f61642e737667\" alt=\"Download\" data-canonical-src=\"https://api.bintray.com/packages/smartcat-labs/maven/cassandra-diagnostics/images/download.svg\" /></a></p>\n<h2><a id=\"user-content-introduction\" class=\"anchor\" aria-hidden=\"true\" href=\"#introduction\"></a>Introduction</h2>\n<p>Cassandra Diagnostics is an extension for Apache Cassandra server node implemented as Java agent. It uses bytecode instrumentation to augment Cassandra node with additional functionalities. The following images depicts the position of Cassandra Diagnostics in a Apache Cassandra based system.</p>\n<p><a target=\"_blank\" href=\"https://github.com/smartcat-labs/cassandra-diagnostics/blob/dev/diagrams/cassandra-diagnostics.png?raw=true\"><img src=\"https://github.com/smartcat-labs/cassandra-diagnostics/raw/dev/diagrams/cassandra-diagnostics.png?raw=true\" alt=\"Placement diagram\" /></a></p>\n<p>Cassandra Diagnostics has a modular architecture. On one side it has connectors for different versions of Apache Cassandra nodes or Cassandra Java Driver and on the other it has various reporters to send measurement to different collecting/monitoring tools. In between lies the core with a set of metrics processing modules. Reusable code goes to commons.</p>\n<p><a target=\"_blank\" href=\"https://github.com/smartcat-labs/cassandra-diagnostics/blob/dev/diagrams/architecture-diagram.png?raw=true\"><img src=\"https://github.com/smartcat-labs/cassandra-diagnostics/raw/dev/diagrams/architecture-diagram.png?raw=true\" alt=\"Architecture diagram\" /></a></p>\n<h3><a id=\"user-content-cassandra-diagnostic-commons\" class=\"anchor\" aria-hidden=\"true\" href=\"#cassandra-diagnostic-commons\"></a>Cassandra Diagnostic Commons</h3>\n<p><a href=\"https://github.com/smartcat-labs/cassandra-diagnostics/blob/dev/cassandra-diagnostics-commons\">Cassandra Diagnostics Commons</a> holds interface for core, connector and reports and it provides signature all the modules need to confront to be able to work together.</p>\n<h3><a id=\"user-content-cassandra-connector\" class=\"anchor\" aria-hidden=\"true\" href=\"#cassandra-connector\"></a>Cassandra Connector</h3>\n<p>Connector is a module which hooks into the query path and extract information for diagnostics. Bytecode instrumentation is used to augment existing Cassandra code with additional functionality. It uses low priority threads to execute the diagnostics information extraction with minimal performance impact to the target code (Cassandra node or application/driver).</p>\n<p>Currently Cassandra Diagnostics implements the following connector implementation:</p>\n<ul><li>\n<p><a href=\"https://github.com/smartcat-labs/cassandra-diagnostics/blob/dev/cassandra-diagnostics-connector21\">Cassandra Connector 2.1</a> is a connector implementation for Cassandra node for Cassandra version 2.1.x.</p>\n</li>\n<li>\n<p><a href=\"https://github.com/smartcat-labs/cassandra-diagnostics/blob/dev/cassandra-diagnostics-connector30\">Cassandra Connector 3.0</a> is a connector implementation for Cassandra node for Cassandra version 3.0.x.</p>\n</li>\n<li>\n<p><a href=\"https://github.com/smartcat-labs/cassandra-diagnostics/blob/dev/cassandra-diagnostics-driver-connector\">Cassandra Driver Connector</a> is a connector implementation for Datastax's Cassandra driver for diagnostics on the application side.</p>\n</li>\n</ul><h3><a id=\"user-content-cassandra-core\" class=\"anchor\" aria-hidden=\"true\" href=\"#cassandra-core\"></a>Cassandra Core</h3>\n<p><a href=\"https://github.com/smartcat-labs/cassandra-diagnostics/blob/dev/cassandra-diagnostics-core\">Cassandra Diagnostics Core</a> is glue between connector and reporters. It holds all the modules for diagnostics, it has business logic for measurement and it decides what will be measured and what would be skipped. Its job is to load provided configuration or to setup sensible defaults.</p>\n<h3><a id=\"user-content-modules\" class=\"anchor\" aria-hidden=\"true\" href=\"#modules\"></a>Modules</h3>\n<p>There are default module implementations which serve as core features. Modules use configured reporters to report their activity.</p>\n<p>Please read <a href=\"https://github.com/smartcat-labs/cassandra-diagnostics/blob/dev/cassandra-diagnostics-core/COREMODULES.md\">core modules README</a> for more information and configuraion options for the modules.Core module implementations:</p>\n<h4><a id=\"user-content-heartbeat-module\" class=\"anchor\" aria-hidden=\"true\" href=\"#heartbeat-module\"></a>Heartbeat Module</h4>\n<p><a href=\"https://github.com/smartcat-labs/cassandra-diagnostics/blob/dev/cassandra-diagnostics-core/COREMODULES.md#heartbeat-module\">Heartbeat Module</a> produces messages to provide feedback that the diagnostics agent is loaded and working. Typical usage is with Log Reporter where it produces INFO message in configured intervals.\nDefault reporting interval is 15 minutes.</p>\n<h4><a id=\"user-content-slow-query-module\" class=\"anchor\" aria-hidden=\"true\" href=\"#slow-query-module\"></a>Slow Query Module</h4>\n<p><a href=\"https://github.com/smartcat-labs/cassandra-diagnostics/blob/dev/cassandra-diagnostics-core/COREMODULES.md#slow-query-module\">Slow Query Module</a> is monitoring execution time of each query and if it is above configured threshold it reports the value and query type using configured reporters.\nDefault query execution time threshold is 25 milliseconds.</p>\n<h4><a id=\"user-content-request-rate-module\" class=\"anchor\" aria-hidden=\"true\" href=\"#request-rate-module\"></a>Request Rate Module</h4>\n<p><a href=\"https://github.com/smartcat-labs/cassandra-diagnostics/blob/dev/cassandra-diagnostics-core/COREMODULES.md#request-rate-module\">Request Rate Module</a> uses codahale metrics library to create rate measurement of executed queries. Rates are reported for configurable statement types and consistency levels using configured reporters in configured periods.\nDefault reporting interval is 1 second.</p>\n<h4><a id=\"user-content-metrics-module\" class=\"anchor\" aria-hidden=\"true\" href=\"#metrics-module\"></a>Metrics Module</h4>\n<p><a href=\"https://github.com/smartcat-labs/cassandra-diagnostics/blob/dev/cassandra-diagnostics-core/COREMODULES.md#metrics-module\">Metrics Module</a> collects Cassandra's metrics, which are exposed over JMX, and ships them using predefined reporters. Metrics package names configuration is the same as a default metrics config reporter uses.\nDefault reporting interval is 1 second.</p>\n<h4><a id=\"user-content-status-module\" class=\"anchor\" aria-hidden=\"true\" href=\"#status-module\"></a>Status Module</h4>\n<p><a href=\"https://github.com/smartcat-labs/cassandra-diagnostics/blob/dev/cassandra-diagnostics-core/COREMODULES.md#status-module\">Status Module</a> is used to report Cassandra information exposed over JMX. It reports compaction information as a single measurement.\nDefault reporting interval is 1 minute.</p>\n<h4><a id=\"user-content-cluster-health-module\" class=\"anchor\" aria-hidden=\"true\" href=\"#cluster-health-module\"></a>Cluster Health Module</h4>\n<p><a href=\"https://github.com/smartcat-labs/cassandra-diagnostics/blob/dev/cassandra-diagnostics-core/COREMODULES.md#cluster-health-module\">Cluster Health Module</a> is used to report the health status of the nodes such as which nodes are marked as DOWN by gossiper. It uses the information exposed over JMX.\nDefault reporting interval is 10 seconds.</p>\n<h4><a id=\"user-content-hiccup-module\" class=\"anchor\" aria-hidden=\"true\" href=\"#hiccup-module\"></a>Hiccup Module</h4>\n<p>Module based on <a href=\"https://github.com/giltene/jHiccup\">jHiccup</a> that logs and reports platform hiccups including JVM stalls. Default reporting period is 5 seconds and reporter values and percentiles from 90 to 100 and Mean and Max values.</p>\n<h3><a id=\"user-content-reporters\" class=\"anchor\" aria-hidden=\"true\" href=\"#reporters\"></a>Reporters</h3>\n<p>Reporters take measurement from core and wrap them up in implementation specific format so it can be sent to reporters target (i.e. Influx reporter transforms measurement to influx query and stores it to InfluxDB).</p>\n<p>Reporter implementations:</p>\n<h4><a id=\"user-content-log-reporter\" class=\"anchor\" aria-hidden=\"true\" href=\"#log-reporter\"></a>Log Reporter</h4>\n<p><a href=\"https://github.com/smartcat-labs/cassandra-diagnostics/blob/dev/cassandra-diagnostics-core/src/main/java/io/smartcat/cassandra/diagnostics/reporter/LogReporter.java\">LogReporter</a> uses the Cassandra logger system to report measurement (this is default reporter and part of core). Reports are logged at the <code>INFO</code> log level in the following pattern:</p>\n<pre>Measurement {} [time={}, value={}, tags={}, fields={}]\n</pre>\n<p>Values for <code>time</code> is given in milliseconds. <code>tags</code> are used to better specify measurement and provide additional searchable labels and fields is a placeholder for additional fields connected to this measurement. Example can be Slow Query measurement, where <code>value</code> is execution time of query, <code>tags</code> can be type of statement (UPDATE or SELECT) so you can differentiate and search easy and <code>fields</code> can hold actual statement, which is not something you want to search against but it is valuable metadata for measurement.</p>\n<h4><a id=\"user-content-riemann-reporter\" class=\"anchor\" aria-hidden=\"true\" href=\"#riemann-reporter\"></a>Riemann Reporter</h4>\n<p><a href=\"https://github.com/smartcat-labs/cassandra-diagnostics/blob/dev/cassandra-diagnostics-reporter-riemann/README.md\">RiemannReporter</a> sends measurements towards <a href=\"http://riemann.io/\" rel=\"nofollow\">Riemann server</a>.</p>\n<h4><a id=\"user-content-influx-reporter\" class=\"anchor\" aria-hidden=\"true\" href=\"#influx-reporter\"></a>Influx Reporter</h4>\n<p><a href=\"https://github.com/smartcat-labs/cassandra-diagnostics/blob/dev/cassandra-diagnostics-reporter-influx/README.md\">InfluxReporter</a> sends measurements towards <a href=\"https://www.influxdata.com/time-series-platform/influxdb/\" rel=\"nofollow\">Influx database</a>.</p>\n<h4><a id=\"user-content-telegraf-reporter\" class=\"anchor\" aria-hidden=\"true\" href=\"#telegraf-reporter\"></a>Telegraf Reporter</h4>\n<p><a href=\"https://github.com/smartcat-labs/cassandra-diagnostics/blob/dev/cassandra-diagnostics-reporter-telegraf/README.md\">Telegraf Reporter</a> sends measurements towards <a href=\"https://github.com/influxdata/telegraf\">Telegraf agent</a>.</p>\n<h4><a id=\"user-content-datadog-reporter\" class=\"anchor\" aria-hidden=\"true\" href=\"#datadog-reporter\"></a>Datadog Reporter</h4>\n<p><a href=\"https://github.com/smartcat-labs/cassandra-diagnostics/blob/dev/cassandra-diagnostics-reporter-datadog/README.md\">Datadog Reporter</a> sends measurements towards <a href=\"https://github.com/DataDog/dd-agent\">Datadog Agent</a> using UDP.</p>\n<h4><a id=\"user-content-kafka-reporter\" class=\"anchor\" aria-hidden=\"true\" href=\"#kafka-reporter\"></a>Kafka Reporter</h4>\n<p><a href=\"https://github.com/smartcat-labs/cassandra-diagnostics/blob/dev/cassandra-diagnostics-reporter-kafka/README.md\">Kafka Reporter</a> sends measurements towards <a href=\"https://kafka.apache.org/\" rel=\"nofollow\">Kafka</a>.</p>\n<h4><a id=\"user-content-prometheus-reporter\" class=\"anchor\" aria-hidden=\"true\" href=\"#prometheus-reporter\"></a>Prometheus Reporter</h4>\n<p><a href=\"https://github.com/smartcat-labs/cassandra-diagnostics/blob/dev/cassandra-diagnostics-reporter-prometheus/README.md\">Prometheus Reporter</a> exposes measurements to be scraped by <a href=\"https://prometheus.io\" rel=\"nofollow\">Prometheus server</a>.</p>\n<h2><a id=\"user-content-configuration\" class=\"anchor\" aria-hidden=\"true\" href=\"#configuration\"></a>Configuration</h2>\n<p>Cassandra Diagnostics uses an external configuration file in YAML format. You can see default configuration in <a href=\"https://github.com/smartcat-labs/cassandra-diagnostics/blob/dev/cassandra-diagnostics-core/src/main/resources/cassandra-diagnostics-default.yml\">cassandra-diagnostics-default.yml</a>. The default name of the config file is <code>cassandra-diagnostics.yml</code> and it is expected to be found on the classpath. This can be changed using property <code>cassandra.diagnostics.config</code>.\nFor example, the configuration can be set explicitly by changing <code>cassandra-env.sh</code> and adding the following line:</p>\n<pre>JVM_OPTS=\"$JVM_OPTS -Dcassandra.diagnostics.config=some-other-cassandra-diagnostics-configuration.yml\"\n</pre>\n<p>The following is an example of the configuration file:</p>\n<pre>global:\n  systemName: \"smartcat-cassandra-cluster\"\nreporters:\n  - reporter: io.smartcat.cassandra.diagnostics.reporter.LogReporter\nmodules:\n  - module: io.smartcat.cassandra.diagnostics.module.slowquery.SlowQueryModule\n    measurement: queryReport\n    options:\n      slowQueryThresholdInMilliseconds: 1\n    reporters:\n      - io.smartcat.cassandra.diagnostics.reporter.LogReporter\n</pre>\n<p>Specific query reporter may require additional configuration options. Those options are specified using <code>options</code> property. The following example shows a configuration options in case of <code>RiemannReporter</code> and it shows how you can configure specific modules to use this reporter:</p>\n<pre>global:\n  systemName: \"smartcat-cassandra-cluster\"\n# Reporters\nreporters:\n  - reporter: io.smartcat.cassandra.diagnostics.reporter.LogReporter\n  - reporter: io.smartcat.cassandra.diagnostics.reporter.RiemannReporter\n    options:\n      riemannHost: 127.0.0.1\n      riemannPort: 5555 #Optional\n      batchEventSize: 50 #Optional\n# Modules\nmodules:\n  - module: io.smartcat.cassandra.diagnostics.module.requestrate.RequestRateModule\n    measurement: requestRate\n    options:\n      period: 1\n      timeunit: SECONDS\n    reporters:\n      - io.smartcat.cassandra.diagnostics.reporter.LogReporter\n      - io.smartcat.cassandra.diagnostics.reporter.RiemannReporter\n</pre>\n<p>By default all measurements are reported with hostname queried with <a href=\"http://docs.oracle.com/javase/7/docs/api/java/net/InetAddress.html\" rel=\"nofollow\">InetAddress</a> java class. If required, hostname can be set using a hostname variable in configuration file:</p>\n<pre>global:\n  systemName: \"smartcat-cassandra-cluster\"\n  hostname: \"test-hostname\"\nreporters:\netc...\n</pre>\n<p>It is important to name system under observation because measurements can be collected by various systems. Hostname is not enough, it is easy to imagine one host having Cassandra node and Kafka node both emitting measurement and we want to group those by system. By default \"cassandra-cluster\" will be used but it is advised to override this to have unique grouping of measurements:</p>\n<pre>global:\n  systemName: \"cassandra-cluster\"\n  hostname: \"test-hostname\"\n</pre>\n<h2><a id=\"user-content-information-provider\" class=\"anchor\" aria-hidden=\"true\" href=\"#information-provider\"></a>Information provider</h2>\n<p>Being deployed on the node itself, diagnostics connector should provide a connection to the node over JMX by wrapping the Cassandra's NodeProbe class with provides access to all actions and metrics exposed over JMX. This is configured in the <code>connector</code> part of the configuration which sits in the root of diagnostics config.</p>\n<pre>connector:\n  jmxHost: 127.0.0.1\n  jmxPort: 7199\n  jmxAuthEnabled: false #Optional\n  jmxUsername: username #Optional\n  jmxPassword: password #Optional\n</pre>\n<p>Status module uses information provided by connector in order to collect info data.</p>\n<h2><a id=\"user-content-control-and-configuration-api\" class=\"anchor\" aria-hidden=\"true\" href=\"#control-and-configuration-api\"></a>Control and Configuration API</h2>\n<p>Cassandra Diagnostics exposes a control and configuration API. This API currently offers the following operations:</p>\n<pre>- getVersion - returns the actual Cassandra Diagnostics version.\n- reload - reloads the configuration\n</pre>\n<p>This API is exposed over JMX and HTTP protocols.</p>\n<p>The Diagnostics API JMX MXBean could be found under the following object name:</p>\n<pre>package io.smartcat.cassandra.diagnostics.api:type=DiagnosticsApi\n</pre>\n<p>The HTTP API is controlled using the following options in the <code>global</code> section in the configuration file:</p>\n<pre>global:\n  # controls if HTTP API is turned on. 'true' by default.\n  httpApiEnabled: true\n  # specifies the host/address part for listening TCP socket. '127.0.0.1' by default.\n  httpApiHost: 127.0.0.1\n  # specifies the port number for the listening TCP socket. '8998' by default.\n  httpApiPort: 8998\n  # if API authorization is enabled, API key must be provided through the 'Authorization' header\n  httpApiAuthEnabled: false\n  # API access key\n  httpApiKey: \"diagnostics-api-key\"\n</pre>\n<p>It implements the following endpoints for mapping HTTP requests to API operations:</p>\n<ul><li><code>GET /version</code> for <code>getVersion</code></li>\n<li><code>POST /reload</code> for <code>reload</code></li>\n</ul><h2><a id=\"user-content-installation\" class=\"anchor\" aria-hidden=\"true\" href=\"#installation\"></a>Installation</h2>\n<p>Script for automated installation is <a href=\"https://github.com/smartcat-labs/cassandra-diagnostics/blob/dev/bash-installer/README.md\">also available</a>.</p>\n<p>Cassandra Diagnostics consists of the following three components:</p>\n<ul><li>Cassandra Diagnostics Core</li>\n<li>Cassandra Diagnostics Connector</li>\n<li>Cassandra Diagnostics Reporter</li>\n</ul><p>Every of these components is packaged into its own JAR file (accompanied with necessary dependencies). These JAR files are available for download on <a href=\"https://mvnrepository.com/artifact/io.smartcat\" rel=\"nofollow\">Maven Central</a> and need to be present on the classpath.</p>\n<p>Pay attention to the fact that Cassandra Diagnostics Connector has to be aligned with the used Cassandra version. For example, <code>cassandra-diagnostics-connector21</code> should be used with Cassandra 2.1.</p>\n<p>Also note that more than one Cassandra Diagnostics Reporter can be used at the same time. That means that all respective JAR files have to be put on the classpath. The only exception to this rule is in case of <code>LogReporter</code> that is built in Cassandra Diagnostics Core and no Reporter JAR has to be added explicitly.</p>\n<p>Place <code>cassandra-diagnostics-core-VERSION.jar</code>, <code>cassandra-diagnostics-connector21-VERSION.jar</code> and required Reporter JARs (e.g. <code>cassandra-diagnostics-reporter-influx-VERSION-all.jar</code>) into Cassandra <code>lib</code> directory.</p>\n<p>Create and place the configuration file <code>cassandra-diagnostics.yml</code> into Cassandra's <code>conf</code> directory.\nAdd the following line at the end of <code>conf/cassandra-env.sh</code>:</p>\n<pre>JVM_OPTS=\"$JVM_OPTS -javaagent:$CASSANDRA_HOME/lib/cassandra-diagnostics-core-VERSION.jar -Dcassandra.diagnostics.config=cassandra-diagnostics.yml\"\n</pre>\n<h2><a id=\"user-content-usage\" class=\"anchor\" aria-hidden=\"true\" href=\"#usage\"></a>Usage</h2>\n<p>Upon Cassandra node start, the Diagnostics agent kicks in and instrument necessary target classes to inject diagnostics additions.\n<code>LogReporter</code> repors slow queries in <code>logs/system.log</code> at <code>INFO</code> level.\nThe dynamic configuration could be inspected/changed using <code>jconsole</code> and connecting to <code>org.apache.cassandra.service.CassandraDaemon</code>.</p>\n<h2><a id=\"user-content-build-and-deploy\" class=\"anchor\" aria-hidden=\"true\" href=\"#build-and-deploy\"></a>Build and deploy</h2>\n<p>Build and deploy process is described <a href=\"https://github.com/smartcat-labs/cassandra-diagnostics/blob/dev/BUILDANDDEPLOY.md\">here</a>.</p>\n<h2><a id=\"user-content-license-and-development\" class=\"anchor\" aria-hidden=\"true\" href=\"#license-and-development\"></a>License and development</h2>\n<p>Cassandra Diagnostics is licensed under the liberal and business-friendly <a href=\"http://www.apache.org/licenses/LICENSE-2.0.html\" rel=\"nofollow\">Apache Licence, Version 2.0</a> and is freely available on GitHub. Cassandra Diagnostics is further released to the repositories of Maven Central and on JCenter. The project is built using <a href=\"http://maven.apache.org/\" rel=\"nofollow\">Maven</a>. From your shell, cloning and building the project would go something like this:</p>\n<pre>git clone https://github.com/smartcat-labs/cassandra-diagnostics.git\ncd cassandra-diagnostics\nmvn package\n</pre>\n</article>"}}]}},"pageContext":{"alternative_id":11797}}