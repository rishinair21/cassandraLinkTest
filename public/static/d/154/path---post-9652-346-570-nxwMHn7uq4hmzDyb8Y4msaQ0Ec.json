{"data":{"allAnantCassandralinks":{"edges":[{"node":{"title":"thelastpickle/cassandra-zipkin-tracing","alternative_id":9652,"content":"<h3>\n      \n      README.md\n    </h3><article class=\"markdown-body entry-content\" itemprop=\"text\">\n<p>Cassandra-3.4 provides <a href=\"http://www.planetcassandra.org/blog/cassandra-3-4-release-overview/\" rel=\"nofollow\">pluggable tracing</a>. By adding 3 jar files to the Cassandra classpath and one jvm option, Cassandra's tracing is replaced with Zipkin. It can even identify incoming Zipkin traces and add Cassandra's own internal tracing on to it.</p>\n<pre>mvn install\ncp target/*.jar $CASSANDRA_HOME/lib/\n</pre>\n<p>Then start Cassandra with</p>\n<pre>JVM_OPTS \\\n  =\"-Dcassandra.custom_tracing_class=com.thelastpickle.cassandra.tracing.ZipkinTracing\" \\\n    cassandra\n</pre>\n<p>Or edit the <code>jvm.options</code>.</p>\n<p>The default SpanCollector sends the tracing messages via HTTP to <code>http://127.0.0.1:9411/</code>. This is the default port for the <a href=\"https://github.com/openzipkin/zipkin-java\">zipkin-java</a> server. The same url is used for the UI.</p>\n<h2><a id=\"user-content-continuing-existing-zipkin-traces\" class=\"anchor\" aria-hidden=\"true\" href=\"#continuing-existing-zipkin-traces\"></a>Continuing existing Zipkin traces</h2>\n<p>To continue existing Zipkin traces from application code through the DataStax CQL driver and into the Cassandra cluster.</p>\n<p>The Cassandra nodes need to be started also with the <code>cassandra.custom_query_handler_class</code> jvm option to a query handler that accepts incoming payloads over the CQL protocol:</p>\n<pre>JVM_OPTS \\\n  =\"-Dcassandra.custom_tracing_class=com.thelastpickle.cassandra.tracing.ZipkinTracing\" \\\n    -Dcassandra.custom_query_handler_class=org.apache.cassandra.cql3.CustomPayloadMirroringQueryHandler\"\n  cassandra\n</pre>\n<p>(Or edit the <code>jvm.options</code>)</p>\n<p>Then in the application code where the DataStax CQL driver is used put the Zipkin traceId and spanId into the <em>outgoing payload</em> like</p>\n<pre>SpanId spanId = clientTracer.startNewSpan(statement.toString());\nByteBuffer traceHeaders = ByteBuffer.wrap(spanId.bytes());\nstatement.setOutgoingPayload(singletonMap(\"zipkin\", traceHeaders.array()));\nclientTracer.setCurrentClientServiceName(serviceName);\nclientTracer.setClientSent();\nResultSet result = session.execute(statement);\nclientTracer.setClientReceived();\nreturn result;\n</pre>\n<h2><a id=\"user-content-more-information\" class=\"anchor\" aria-hidden=\"true\" href=\"#more-information\"></a>More information</h2>\n<p>See this <a href=\"http://thelastpickle.com/files/2015-09-24-using-zipkin-for-full-stack-tracing-including-cassandra/presentation/tlp-reveal.js/tlp-cassandra-zipkin.html\" rel=\"nofollow\">presentation</a>.</p>\n<h2><a id=\"user-content-background\" class=\"anchor\" aria-hidden=\"true\" href=\"#background\"></a>Background</h2>\n<p>See <a href=\"https://issues.apache.org/jira/browse/CASSANDRA-10392\" rel=\"nofollow\">CASSANDRA-10392</a> for the patch to extend Cassandra's tracing that this project plugs into.</p>\n<h2><a id=\"user-content-troubleshooting\" class=\"anchor\" aria-hidden=\"true\" href=\"#troubleshooting\"></a>Troubleshooting</h2>\n<p>When this tracing is used instead of Cassandra's default tracing, any cqlsh statements run after enabling tracing with\n<code>TRACING ON;</code> are going to time out eventually giving</p>\n<pre>Unable to fetch query trace: Trace information was not available within â€¦\n</pre>\n<p>This is because cqlsh is polling for tracing information in system_traces which isn't any longer being created. Zipkin tracing doesn't support this interaction with cqlsh (it's more of a thing to use with a tracing sampling rate). Improvements in this area are possible though, for example we could use zipkin tracing when the custom payload contains a zipkin traceId and spanId and fall back to normal tracing otherwise (which would work for cqlsh interaction). For the meantime an easy fix around this behaviour in cqlsh is to reduce Session.max_trace_wait down to 1 second.</p>\n</article>"}}]}},"pageContext":{"alternative_id":9652}}