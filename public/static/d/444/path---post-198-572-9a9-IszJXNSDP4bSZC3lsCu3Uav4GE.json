{"data":{"allAnantCassandralinks":{"edges":[{"node":{"title":"Cassandra Lucene Index","alternative_id":198,"content":"<p>Stratio’s Cassandra Lucene Index, derived from <a href=\"https://github.com/Stratio/stratio-cassandra\">Stratio Cassandra</a>, is\na plugin for <a href=\"http://cassandra.apache.org/\" rel=\"nofollow\">Apache Cassandra</a> that extends its index functionality to provide near\nreal time search such as ElasticSearch or Solr, including <a href=\"http://en.wikipedia.org/wiki/Full_text_search\" rel=\"nofollow\">full text search</a>\ncapabilities and free multivariable, geospatial and bitemporal search. It is achieved through an <a href=\"http://lucene.apache.org/\" rel=\"nofollow\">Apache Lucene</a>\nbased implementation of Cassandra secondary indexes, where each node of the cluster indexes its own data. Stratio’s\nCassandra indexes are one of the core modules on which <a href=\"http://www.stratio.com/\" rel=\"nofollow\">Stratio’s BigData platform</a> is based.</p><p><a target=\"_blank\" href=\"https://github.com/Stratio/cassandra-lucene-index/blob/branch-3.0.14/doc/resources/architecture.png\"><img alt=\"architecture\" src=\"https://github.com/Stratio/cassandra-lucene-index/raw/branch-3.0.14/doc/resources/architecture.png\" /></a></p><p>Index <a href=\"http://en.wikipedia.org/wiki/Relevance_(information_retrieval)\" rel=\"nofollow\">relevance searches</a> allow you to retrieve the\n<em>n</em> more relevant results satisfying a search. The coordinator node sends the search to each node in the cluster, each node\nreturns its <em>n</em> best results and then the coordinator combines these partial results and gives you the <em>n</em> best of them,\navoiding full scan. You can also base the sorting in a combination of fields.</p><p>Any cell in the tables can be indexed, including those in the primary key as well as collections. Wide rows are also\nsupported. You can scan token/key ranges, apply additional CQL3 clauses and page on the filtered results.</p><p>Index filtered searches are a powerful help when analyzing the data stored in Cassandra with <a href=\"http://es.wikipedia.org/wiki/MapReduce\" rel=\"nofollow\">MapReduce</a>\nframeworks as <a href=\"http://hadoop.apache.org/\" rel=\"nofollow\">Apache Hadoop</a> or, even better, <a href=\"http://spark.apache.org/\" rel=\"nofollow\">Apache Spark</a>.\nAdding Lucene filters in the jobs input can dramatically reduce the amount of data to be processed, avoiding full scan.</p><p><a target=\"_blank\" href=\"https://github.com/Stratio/cassandra-lucene-index/blob/branch-3.0.14/doc/resources/spark_architecture.png\"><img alt=\"spark_architecture\" src=\"https://github.com/Stratio/cassandra-lucene-index/raw/branch-3.0.14/doc/resources/spark_architecture.png\" /></a></p><p>The following benchmark result can give you an idea about the expected performance when combining Lucene indexes with\nSpark. We do successive queries requesting from the 1% to 100% of the stored data. We can see a high performance for the\nindex for the queries requesting strongly filtered data. However, the performance decays in less restrictive queries.\nAs the number of records returned by the query increases, we reach a point where the index becomes slower than the full\nscan. So, the decision to use indexes in your Spark jobs depends on the query selectivity. The trade-off between both\napproaches depends on the particular use case. Generally, combining Lucene indexes with Spark is recommended for jobs\nretrieving no more than the 25% of the stored data.</p><p><a target=\"_blank\" href=\"https://github.com/Stratio/cassandra-lucene-index/blob/branch-3.0.14/doc/resources/spark_performance.png\"><img alt=\"spark_performance\" src=\"https://github.com/Stratio/cassandra-lucene-index/raw/branch-3.0.14/doc/resources/spark_performance.png\" /></a></p><p>This project is not intended to replace Apache Cassandra denormalized tables, inverted indexes, and/or secondary\nindexes. It is just a tool to perform some kind of queries which are really hard to be addressed using Apache Cassandra\nout of the box features, filling the gap between real-time and analytics.</p><p><a target=\"_blank\" href=\"https://github.com/Stratio/cassandra-lucene-index/blob/branch-3.0.14/doc/resources/oltp_olap.png\"><img alt=\"oltp_olap\" src=\"https://github.com/Stratio/cassandra-lucene-index/raw/branch-3.0.14/doc/resources/oltp_olap.png\" /></a></p><p>More detailed information is available at <a href=\"https://github.com/Stratio/cassandra-lucene-index/blob/branch-3.0.14/doc/documentation.rst\">Stratio’s Cassandra Lucene Index documentation</a>.</p><h2>Features</h2><p>Lucene search technology integration into Cassandra provides:</p><p>Stratio’s Cassandra Lucene Index and its integration with Lucene search technology provides:</p><ul><li>Full text search (language-aware analysis, wildcard, fuzzy, regexp)</li>\n<li>Boolean search (and, or, not)</li>\n<li>Sorting by relevance, column value, and distance</li>\n<li>Geospatial indexing (points, lines, polygons and their multiparts)</li>\n<li>Geospatial transformations (bounding box, buffer, centroid, convex hull, union, difference, intersection)</li>\n<li>Geospatial operations (intersects, contains, is within)</li>\n<li>Bitemporal search (valid and transaction time durations)</li>\n<li>CQL complex types (list, set, map, tuple and UDT)</li>\n<li>CQL user defined functions (UDF)</li>\n<li>CQL paging, even with sorted searches</li>\n<li>Columns with TTL</li>\n<li>Third-party CQL-based drivers compatibility</li>\n<li>Spark and Hadoop compatibility</li>\n</ul><p>Not yet supported:</p><ul><li>Thrift API</li>\n<li>Legacy compact storage option</li>\n<li>Indexing <code>counter</code> columns</li>\n<li>Indexing static columns</li>\n<li>Other partitioners than Murmur3</li>\n</ul><h2>Requirements</h2><ul><li>Cassandra (identified by the three first numbers of the plugin version)</li>\n<li>Java &gt;= 1.8 (OpenJDK and Sun have been tested)</li>\n<li>Maven &gt;= 3.0</li>\n</ul><h2>Build and install</h2><p>Stratio’s Cassandra Lucene Index is distributed as a plugin for Apache Cassandra. Thus, you just need to build a JAR\ncontaining the plugin and add it to the Cassandra’s classpath:</p><ul><li>Clone the project: <code>git clone http://github.com/Stratio/cassandra-lucene-index</code></li>\n<li>Change to the downloaded directory: <code>cd cassandra-lucene-index</code></li>\n<li>Checkout a plugin version suitable for your Apache Cassandra version: <code>git checkout A.B.C.X</code></li>\n<li>Build the plugin with Maven: <code>mvn clean package</code></li>\n<li>Copy the generated JAR to the lib folder of your compatible Cassandra installation:\n<code>cp plugin/target/cassandra-lucene-index-plugin-*.jar &lt;CASSANDRA_HOME&gt;/lib/</code></li>\n<li>Start/restart Cassandra as usual.</li>\n</ul><p>Specific Cassandra Lucene index versions are targeted to specific Apache Cassandra versions. So, cassandra-lucene-index\nA.B.C.X is aimed to be used with Apache Cassandra A.B.C, e.g.\n<a href=\"http://www.github.com/Stratio/cassandra-lucene-index/tree/3.0.7.1\">cassandra-lucene-index:3.0.7.1</a> for\n<a href=\"http://www.github.com/apache/cassandra/tree/cassandra-3.0.7\">cassandra:3.0.7</a>. Please note that production-ready\nreleases are version tags (e.g. 3.0.6.3), don't use branch-X nor master branches in production.</p><p>Alternatively, patching can also be done with this Maven profile, specifying the path of your Cassandra installation,\nthis task also deletes previous plugin's JAR versions in CASSANDRA_HOME/lib/ directory:</p><div class=\"highlight highlight-source-shell\"><pre>mvn clean package -Ppatch -Dcassandra_home=&lt;CASSANDRA_HOME&gt;</pre></div><p>If you don’t have an installed version of Cassandra, there is also an alternative profile to let Maven download and\npatch the proper version of Apache Cassandra:</p><div class=\"highlight highlight-source-shell\"><pre>mvn clean package -Pdownload_and_patch -Dcassandra_home=&lt;CASSANDRA_HOME&gt;</pre></div><p>Now you can run Cassandra and do some tests using the Cassandra Query Language:</p><div class=\"highlight highlight-source-shell\"><pre>&lt;CASSANDRA_HOME&gt;/bin/cassandra -f\n&lt;CASSANDRA_HOME&gt;/bin/cqlsh</pre></div><p>The Lucene’s index files will be stored in the same directories where the Cassandra’s will be. The default data\ndirectory is <code>/var/lib/cassandra/data</code>, and each index is placed next to the SSTables of its indexed column family.</p><p>Remember that if you use geo shape search you need to <a href=\"https://github.com/Stratio/cassandra-lucene-index/blob/branch-3.0.14/doc/documentation.rst#geo-shape-mapper\">include the JTS jar</a>.</p><p>For more details about Apache Cassandra please see its <a href=\"http://cassandra.apache.org/\" rel=\"nofollow\">documentation</a>.</p><h2>Examples</h2><p>We will create the following table to store tweets:</p><div class=\"highlight highlight-source-sql\"><pre>CREATE KEYSPACE demo\nWITH REPLICATION = {'class': 'SimpleStrategy', 'replication_factor': 1};\nUSE demo;\nCREATE TABLE tweets (\n   id INT PRIMARY KEY,\n   user TEXT,\n   body TEXT,\n   time TIMESTAMP,\n   latitude FLOAT,\n   longitude FLOAT\n);</pre></div><p>Now you can create a custom Lucene index on it with the following statement:</p><div class=\"highlight highlight-source-sql\"><pre>CREATE CUSTOM INDEX tweets_index ON tweets ()\nUSING 'com.stratio.cassandra.lucene.Index'\nWITH OPTIONS = {\n   'refresh_seconds': '1',\n   'schema': '{\n      fields: {\n         id: {type: \"integer\"},\n         user: {type: \"string\"},\n         body: {type: \"text\", analyzer: \"english\"},\n         time: {type: \"date\", pattern: \"yyyy/MM/dd\"},\n         place: {type: \"geo_point\", latitude: \"latitude\", longitude: \"longitude\"}\n      }\n   }'\n};</pre></div><p>This will index all the columns in the table with the specified types, and it will be refreshed once per second.\nAlternatively, you can explicitly refresh all the index shards with an empty search with consistency <code>ALL</code>:</p><div class=\"highlight highlight-source-sql\"><pre>CONSISTENCY ALL\nSELECT * FROM tweets WHERE expr(tweets_index, '{refresh:true}');\nCONSISTENCY QUORUM</pre></div><p>Now, to search for tweets within a certain date range:</p><div class=\"highlight highlight-source-sql\"><pre>SELECT * FROM tweets WHERE expr(tweets_index, '{\n   filter: {type: \"range\", field: \"time\", lower: \"2014/04/25\", upper: \"2014/05/01\"}\n}');</pre></div><p>The same search can be performed forcing an explicit refresh of the involved index shards:</p><div class=\"highlight highlight-source-sql\"><pre>SELECT * FROM tweets WHERE expr(tweets_index, '{\n   filter: {type: \"range\", field: \"time\", lower: \"2014/04/25\", upper: \"2014/05/01\"},\n   refresh: true\n}') limit 100;</pre></div><p>Now, to search the top 100 more relevant tweets where <em>body</em> field contains the phrase “big data gives organizations”\nwithin the aforementioned date range:</p><div class=\"highlight highlight-source-sql\"><pre>SELECT * FROM tweets WHERE expr(tweets_index, '{\n   filter: {type: \"range\", field: \"time\", lower: \"2014/04/25\", upper: \"2014/05/01\"},\n   query: {type: \"phrase\", field: \"body\", value: \"big data gives organizations\", slop: 1}\n}') LIMIT 100;</pre></div><p>To refine the search to get only the tweets written by users whose names start with \"a\":</p><div class=\"highlight highlight-source-sql\"><pre>SELECT * FROM tweets WHERE expr(tweets_index, '{\n   filter: [\n      {type: \"range\", field: \"time\", lower: \"2014/04/25\", upper: \"2014/05/01\"},\n      {type: \"prefix\", field: \"user\", value: \"a\"}\n   ],\n   query: {type: \"phrase\", field: \"body\", value: \"big data gives organizations\", slop: 1}\n}') LIMIT 100;</pre></div><p>To get the 100 more recent filtered results you can use the <em>sort</em> option:</p><div class=\"highlight highlight-source-sql\"><pre>SELECT * FROM tweets WHERE expr(tweets_index, '{\n   filter: [\n      {type: \"range\", field: \"time\", lower: \"2014/04/25\", upper: \"2014/05/01\"},\n      {type: \"prefix\", field: \"user\", value: \"a\"}\n   ],\n   query: {type: \"phrase\", field: \"body\", value: \"big data gives organizations\", slop: 1},\n   sort: {field: \"time\", reverse: true}\n}') limit 100;</pre></div><p>The previous search can be restricted to tweets created close to a geographical position:</p><div class=\"highlight highlight-source-sql\"><pre>SELECT * FROM tweets WHERE expr(tweets_index, '{\n   filter: [\n      {type: \"range\", field: \"time\", lower: \"2014/04/25\", upper: \"2014/05/01\"},\n      {type: \"prefix\", field: \"user\", value: \"a\"},\n      {type: \"geo_distance\", field: \"place\", latitude: 40.3930, longitude: -3.7328, max_distance: \"1km\"}\n   ],\n   query: {type: \"phrase\", field: \"body\", value: \"big data gives organizations\", slop: 1},\n   sort: {field: \"time\", reverse: true}\n}') limit 100;</pre></div><p>It is also possible to sort the results by distance to a geographical position:</p><div class=\"highlight highlight-source-sql\"><pre>SELECT * FROM tweets WHERE expr(tweets_index, '{\n   filter: [\n      {type: \"range\", field: \"time\", lower: \"2014/04/25\", upper: \"2014/05/01\"},\n      {type: \"prefix\", field: \"user\", value: \"a\"},\n      {type: \"geo_distance\", field: \"place\", latitude: 40.3930, longitude: -3.7328, max_distance: \"1km\"}\n   ],\n   query: {type: \"phrase\", field: \"body\", value: \"big data gives organizations\", slop: 1},\n   sort: [\n      {field: \"time\", reverse: true},\n      {field: \"place\", type: \"geo_distance\", latitude: 40.3930, longitude: -3.7328}\n   ]\n}') limit 100;</pre></div><p>Last but not least, you can route any search to a certain token range or partition, in such a way that only a\nsubset of the cluster nodes will be hit, saving precious resources:</p><div class=\"highlight highlight-source-sql\"><pre>SELECT * FROM tweets WHERE expr(tweets_index, '{\n   filter: [\n      {type: \"range\", field: \"time\", lower: \"2014/04/25\", upper: \"2014/05/01\"},\n      {type: \"prefix\", field: \"user\", value: \"a\"},\n      {type: \"geo_distance\", field: \"place\", latitude: 40.3930, longitude: -3.7328, max_distance: \"1km\"}\n   ],\n   query: {type: \"phrase\", field: \"body\", value: \"big data gives organizations\", slop: 1},\n   sort: [\n      {field: \"time\", reverse: true},\n      {field: \"place\", type: \"geo_distance\", latitude: 40.3930, longitude: -3.7328}\n   ]\n}') AND TOKEN(id) &gt;= TOKEN(0) AND TOKEN(id) &lt; TOKEN(10000000) limit 100;</pre></div><p>This last is the basis for <a href=\"https://github.com/Stratio/cassandra-lucene-index/blob/branch-3.0.14/doc/documentation.rst#spark-and-hadoop\">Hadoop, Spark and other MapReduce frameworks support</a>.</p><p>Please, refer to the comprehensive <a href=\"https://github.com/Stratio/cassandra-lucene-index/blob/branch-3.0.14/doc/documentation.rst\">Stratio’s Cassandra Lucene Index documentation</a>.</p>"}}]}},"pageContext":{"alternative_id":198}}