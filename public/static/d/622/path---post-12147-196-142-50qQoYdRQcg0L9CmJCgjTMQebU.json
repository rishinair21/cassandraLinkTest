{"data":{"allAnantCassandralinks":{"edges":[{"node":{"title":"Third contact with a Monolith - Long Range Sensor Scan - Instaclustr","alternative_id":12147,"content":"<p><a href=\"https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/6de5fa5f6be3a4d882e36395e3def498-a-space-odyssey-stanley-kubrick.jpg\"><img class=\"aligncenter wp-image-6433 size-full\" src=\"https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/6de5fa5f6be3a4d882e36395e3def498-a-space-odyssey-stanley-kubrick.jpg\" alt=\"2001 a space odyssey - Third Contatc with the monolith Instaclustr\" width=\"736\" height=\"1127\" srcset=\"https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/6de5fa5f6be3a4d882e36395e3def498-a-space-odyssey-stanley-kubrick.jpg 736w, https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/6de5fa5f6be3a4d882e36395e3def498-a-space-odyssey-stanley-kubrick-196x300.jpg 196w, https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/6de5fa5f6be3a4d882e36395e3def498-a-space-odyssey-stanley-kubrick-669x1024.jpg 669w, https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/6de5fa5f6be3a4d882e36395e3def498-a-space-odyssey-stanley-kubrick-402x616.jpg 402w, https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/6de5fa5f6be3a4d882e36395e3def498-a-space-odyssey-stanley-kubrick-418x640.jpg 418w, https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/6de5fa5f6be3a4d882e36395e3def498-a-space-odyssey-stanley-kubrick-31x48.jpg 31w, https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/6de5fa5f6be3a4d882e36395e3def498-a-space-odyssey-stanley-kubrick-71x108.jpg 71w\" /></a></p><p><img class=\"aligncenter wp-image-6819 size-full\" src=\"https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Distance-of-the-Planets-from-the-sun-in-Astronomical-Units-Instaclustr.png\" alt=\"Distance of the Planets from the sun in Astronomical Units Instaclustr\" width=\"599\" height=\"196\" srcset=\"https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Distance-of-the-Planets-from-the-sun-in-Astronomical-Units-Instaclustr.png 599w, https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Distance-of-the-Planets-from-the-sun-in-Astronomical-Units-Instaclustr-300x98.png 300w, https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Distance-of-the-Planets-from-the-sun-in-Astronomical-Units-Instaclustr-147x48.png 147w, https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Distance-of-the-Planets-from-the-sun-in-Astronomical-Units-Instaclustr-330x108.png 330w\" /></p><h6><strong>Earth to Mars distance = 0.52 AU (1.52-1AU, 78M km)</strong></h6><h6><strong>Earth to Jupiter distance = 4.2 AU (5.2-1AU, 628M km)</strong></h6><p>It’s a long way to Jupiter, would you like to:</p><h6><strong>(a) sleep the whole way in suspended animation?  (bad choice, you don’t wake up)</strong></h6><h6><strong>(b) be embodied as HAL the AI? (go crazy and get unplugged)?</strong></h6><h6><strong>(c) be one of the two crew to stay awake the entire journey (only one of you survives)?</strong></h6><p>What can we do to find out more about our eventual destination the meantime and relieve the boredom?</p><p>In the traditions of the best sci-fi, there are always tricks to speed things up or cut down on the special effects budget. In <i>Star Trek</i> these were Sensors to Scan distant phenomenon:</p><p><a href=\"https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Spock-and-the-Enterprise-bridge-sensor-display.jpg\"><img class=\"aligncenter wp-image-6820 size-large\" src=\"https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Spock-and-the-Enterprise-bridge-sensor-display-1024x765.jpg\" alt=\"Spock and the Enterprise bridge sensor display\" width=\"1024\" height=\"765\" srcset=\"https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Spock-and-the-Enterprise-bridge-sensor-display.jpg 1024w, https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Spock-and-the-Enterprise-bridge-sensor-display-300x224.jpg 300w, https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Spock-and-the-Enterprise-bridge-sensor-display-768x574.jpg 768w, https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Spock-and-the-Enterprise-bridge-sensor-display-825x616.jpg 825w, https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Spock-and-the-Enterprise-bridge-sensor-display-640x478.jpg 640w, https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Spock-and-the-Enterprise-bridge-sensor-display-64x48.jpg 64w, https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Spock-and-the-Enterprise-bridge-sensor-display-145x108.jpg 145w\" /></a></p><p>And the Transporter which used Materialization and Dematerialization to beam people to and from the ship and the surface of planets. </p><p>Energize!</p><p><a href=\"https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Star-Trek-Energize-Instaclustr.png\"><img class=\"wp-image-6821 size-large aligncenter\" src=\"https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Star-Trek-Energize-Instaclustr-1024x764.png\" alt=\"Start Trek - Energize Instaclustr\" width=\"1024\" height=\"764\" srcset=\"https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Star-Trek-Energize-Instaclustr-1024x764.png 1024w, https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Star-Trek-Energize-Instaclustr-300x224.png 300w, https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Star-Trek-Energize-Instaclustr-768x573.png 768w, https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Star-Trek-Energize-Instaclustr-825x616.png 825w, https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Star-Trek-Energize-Instaclustr-640x478.png 640w, https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Star-Trek-Energize-Instaclustr-64x48.png 64w, https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Star-Trek-Energize-Instaclustr-145x108.png 145w, https://24b4dt1v60e526bo2p349l4c-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Star-Trek-Energize-Instaclustr.png 1522w\" /></a></p><p>At the risk of mixing sci-fi movie metaphors:</p><p><em>“Captain’s Log, Stardate 1672.1. Warp drive offline. We’re running on auxiliary impulse engines to Jupiter to explore an anomaly. Our mission is to explore a snapshot of the Instametrics monitoring data on a Cassandra cluster that has appeared around the orbit of Jupiter. Our goal is to predict long JVM garbage collection durations at least five minutes in advance. Initiating long-range sensor scans after which I will attempt a risky long-range transportation down to the surface of the anomaly.”</em></p><p>Let’s get <a href=\"https://www.instaclustr.com/apache-cassandra/\">Cassandra</a> to do all the hard work to reduce the amount of data we need to transfer from the cluster to my laptop. There are two approaches that may result in some useful insights. Calculating some summary statistics, and creating a materialized view.</p><p>The first challenge is connecting to the Cassandra cluster. Unlike the trial cluster example I used previously, this cluster had been created with private IP broadcast_rpc_adresses rather than public IP addresses. Does this mean I can’t connect to the cluster from outside the private address range at all? Not exactly. You can still connect via a single public IP address, which will then become the only controller node your client communicates with. For testing, this is probably ok, but there is a <a href=\"https://www.instaclustr.com/apache-cassandra-deployed-on-private-and-public-networks/\">better solution</a> using VPC peering and the private IP addresses.</p><p>The next step is to see what JVM GC related metrics were collected. </p><p>Connecting via the cqlshell, we can run some CQL commands. </p><p>Describe instametrics;</p><p>Reveals that there are some meta-data tables which contain all the host names, and all the metric (“service”) names for each host:</p><p>How many nodes are there in this sample data set? </p><p>cqlsh&gt; select count(host) from instametrics.host;</p><p><b>system.count(host)<br /></b>————————–<br /><b>                               591</b></p><p>The next question I had was how many metrics are there per node? Using a sample of the host names found in the host table I ran this query a few times:</p><p>select count(service) from instametrics.service_per_host where host=’random host name’;</p><p>The somewhat surprising answer was between 1 and lots (16122!). About 1000 seemed an average so this means about 591*1000 metrics in total = 591,000. </p><p>From this distance, we therefore need to focus on just a few metrics. Selecting all the metrics available for one host we find that the following are the only metrics directly related to JVM GC.</p><p><b>collectionCount</b> is the count of the GC, and <b>collectionTime</b> is the total GC collection time, since last JVM restart.</p><h6><strong>/cassandra/jvm/gc/ConcurrentMarkSweep/collectionCount                                                                               </strong></h6><h6><strong>/cassandra/jvm/gc/ConcurrentMarkSweep/collectionTime</strong></h6><p><b>duration</b> is the time of the last occurring GC, and <b>startTime</b> and <b>endTime</b> are the time of the start and end of the last occurring GC.</p><h6><strong>/cassandra/jvm/gc/ConcurrentMarkSweep/lastGc/duration</strong></h6><h6><strong>/cassandra/jvm/gc/ConcurrentMarkSweep/lastGc/endTime</strong></h6><h6><strong>/</strong>cassandra<strong>/</strong>jvm<strong>/</strong>gc<strong>/ConcurrentMarkSweep/</strong>lastGc<strong>/</strong>startTime</h6><p>I normally start a data analysis by looking at statistics for some of the metrics of interest, such as distribution (e.g. a CDF graph) or a histogram.  But to compute these statistics you need access to all the data…</p><p>Kirk: “Mister Spock. Full sensor scan of the anomaly, please.”</p><p>Spock:  “Captain,  the results are not logical – I’m picking up what looks like Buckets – Fascinating!”</p><p>Buckets can be problematic:</p><ul><li>A drop in the bucket</li>\n<li>To kick the bucket</li>\n<li>There’s a hole in my bucket</li>\n</ul><p>The table with the actual values for the hosts and services is defined as follows:</p><p>The partition key requires values for <b>host, bucket_time </b>and<b> service</b> to select a subset of rows.   What’s bucket_time? Based on the name of the table and inspecting a sample of the rows, it’s the timestamp truncated to 5 minute bucket periods. How do we find the range of bucket_time values for the table? Here’s a few ways… You just “know it” (but I don’t).  The range has been recorded in another table (not that I can see). Or, start from now and search backwards in time by 5 minute intervals. This assumes that the data is really from the past and not the future. Start from the Epoch and search forward? Do a binary search between the Epoch and now? Look at samples of the data? This revealed that at least some of the data was from the early part of 2016. This would give us a starting point to search forwards and backwards in time until gaps are detected when we can assume they are the temporal boundaries of the data (assuming there aren’t large gaps in the data).</p><p>An alternative approach is to make a copy of the table with bucket_time removed from the partition key. Is this possible? Well, yes, in theory. <a href=\"http://cassandra.apache.org/doc/latest/cql/mvs.html\">Materialized VIews </a>are possible in Cassandra, and can even be created from existing tables. I created two materialized views, one with the values ordered (descending), and one with the time ordered (ascending).</p><p>Note that the rules for Materialized Views are very specific. You have to include all the columns from the original PRIMARY KEY in the new table (but they can be in the partition or cluster keys and in different orders), you can include at most one extra column in the new primary key, and the select has to be present and include at least one column – even though the partition key columns are selected by default). The idea was to use the first materialized view to get some summary statistics of the GC durations (e.g. min, average, max), and the second for queries over specific time periods and metrics (to find GCs, and heap memory used between GCs).</p><p>This worked as expected, taking 172 seconds, with these results:</p><p>Total time = 172343, nodes = 591</p><p>Overall stats: Min = 47.0</p><p>Overall stats: Avg = 6555.39</p><p>Overall stats: Max = 56095.0</p><p>The maximum GC duration was 56s, with an “average” of 6.5s.</p><p>Here’s the partial code I used:</p><p>On closer inspection, the average values were incorrect, as the GC duration values are repeated for multiple timestamps.  However, I also obtained the max GC duration for each node, revealing that about 200 nodes (out of 591) had maximum GC durations greater than 10s. This is a good start for “remote” data analysis.</p><aside class=\"content-cta\"><div class=\"primary\"><h4>Related Articles:</h4></div></aside>"}}]}},"pageContext":{"alternative_id":12147}}