{"data":{"allAnantCassandralinks":{"edges":[{"node":{"title":"IBM/Scalable-Cassandra-deployment-on-Kubernetes","alternative_id":12458,"content":"<p><a href=\"https://travis-ci.org/IBM/Scalable-Cassandra-deployment-on-Kubernetes\" rel=\"nofollow\"><img src=\"https://camo.githubusercontent.com/27545c8485cc40771fd0f03ff9844c25de517778/68747470733a2f2f7472617669732d63692e6f72672f49424d2f5363616c61626c652d43617373616e6472612d6465706c6f796d656e742d6f6e2d4b756265726e657465732e7376673f6272616e63683d6d6173746572\" alt=\"Build Status\" data-canonical-src=\"https://travis-ci.org/IBM/Scalable-Cassandra-deployment-on-Kubernetes.svg?branch=master\" /></a></p>\n<p><em>Read this in other languages: <a href=\"https://github.com/IBM/Scalable-Cassandra-deployment-on-Kubernetes/blob/master/README-ko.md\">한국어</a>、<a href=\"https://github.com/IBM/Scalable-Cassandra-deployment-on-Kubernetes/blob/master/README-cn.md\">中国</a>.</em></p>\n<p>This project demonstrates the deployment of a multi-node scalable Cassandra cluster on Kubernetes. Apache Cassandra is a massively scalable open source NoSQL database. Cassandra is perfect for managing large amounts of structured, semi-structured, and unstructured data across multiple datacenters and the cloud.</p>\n<p>Leveraging Kubernetes concepts such as <a href=\"https://kubernetes.io/docs/concepts/storage/persistent-volumes/\" rel=\"nofollow\">PersistentVolume</a> and <a href=\"https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/\" rel=\"nofollow\">StatefulSets</a>, we can provide a resilient installation of Cassandra and be confident that its data (state) are safe.</p>\n<p>We also utilize a <a href=\"https://kubernetes.io/docs/concepts/services-networking/service/#headless-services\" rel=\"nofollow\">\"headless\" service</a> for Cassandra. This way we can provide a way for applications to access it via <a href=\"https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/\" rel=\"nofollow\">KubeDNS</a> and not expose it to the outside world. To access it from your developer workstation you can use <code>kubectl exec</code> commands against any of the cassandra pods. If you do wish to connect an application to it you can use the KubeDNS value of <code>cassandra.default.svc.cluster.local</code> when configuring your application.</p>\n<p><a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://github.com/IBM/Scalable-Cassandra-deployment-on-Kubernetes/blob/master/images/kube-cassandra-code.png\"><img src=\"https://github.com/IBM/Scalable-Cassandra-deployment-on-Kubernetes/raw/master/images/kube-cassandra-code.png\" alt=\"kube-cassandra\" /></a></p>\n<h2><a id=\"user-content-kubernetes-concepts-used\" class=\"anchor\" aria-hidden=\"true\" href=\"#kubernetes-concepts-used\"></a>Kubernetes Concepts Used</h2>\n<ul><li><a href=\"https://kubernetes.io/docs/user-guide/pods\" rel=\"nofollow\">Kubenetes Pods</a></li>\n<li><a href=\"https://kubernetes.io/docs/user-guide/services\" rel=\"nofollow\">Kubenetes Services</a></li>\n<li><a href=\"https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/\" rel=\"nofollow\">Kubernets StatefulSets</a></li>\n</ul><h2><a id=\"user-content-included-components\" class=\"anchor\" aria-hidden=\"true\" href=\"#included-components\"></a>Included Components</h2>\n<ul><li><a href=\"https://console.ng.bluemix.net/docs/containers/cs_ov.html#cs_ov\" rel=\"nofollow\">Kubernetes Clusters</a></li>\n<li><a href=\"https://console.ng.bluemix.net/catalog/?taxonomyNavigation=apps&amp;category=containers\" rel=\"nofollow\">Bluemix container service</a></li>\n<li><a href=\"https://www.ibm.com/cloud-computing/products/ibm-cloud-private/\" rel=\"nofollow\">IBM Cloud Private</a></li>\n<li><a href=\"http://cassandra.apache.org/\" rel=\"nofollow\">Cassandra</a></li>\n</ul><h2><a id=\"user-content-getting-started\" class=\"anchor\" aria-hidden=\"true\" href=\"#getting-started\"></a>Getting Started</h2>\n<p>In order to follow this guide you'll need a Kubernetes cluster. If you do not have access to an existing Kubernetes cluster then follow the instructions (in the link) for one of the following:</p>\n<p><em>The code here is regularly tested against <a href=\"https://console.ng.bluemix.net/docs/containers/cs_ov.html#cs_ov\" rel=\"nofollow\">Kubernetes Cluster from Bluemix Container Service</a> using Travis CI.</em></p>\n<p>After installing (or setting up your access to) Kubernetes ensure that you can access it by running the following and confirming you get version responses for both the Client and the Server:</p>\n<div class=\"highlight highlight-source-shell\"><pre>$ kubectl version\nClient Version: version.Info{Major:\"1\", Minor:\"7\", GitVersion:\"v1.7.5\", GitCommit:\"17d7182a7ccbb167074be7a87f0a68bd00d58d97\", GitTreeState:\"clean\", BuildDate:\"2017-08-31T09:14:02Z\", GoVersion:\"go1.8.3\", Compiler:\"gc\", Platform:\"linux/amd64\"}\nServer Version: version.Info{Major:\"1\", Minor:\"7\", GitVersion:\"v1.7.5\", GitCommit:\"17d7182a7ccbb167074be7a87f0a68bd00d58d97\", GitTreeState:\"clean\", BuildDate:\"2017-09-18T20:30:29Z\", GoVersion:\"go1.8.3\", Compiler:\"gc\", Platform:\"linux/amd64\"}</pre></div>\n<h2><a id=\"user-content-create-a-cassandra-service-for-cassandra-cluster-formation-and-discovery\" class=\"anchor\" aria-hidden=\"true\" href=\"#create-a-cassandra-service-for-cassandra-cluster-formation-and-discovery\"></a>Create a Cassandra Service for Cassandra cluster formation and discovery</h2>\n<h3><a id=\"user-content-1-create-a-cassandra-headless-service\" class=\"anchor\" aria-hidden=\"true\" href=\"#1-create-a-cassandra-headless-service\"></a>1. Create a Cassandra Headless Service</h3>\n<p>To allow us to do simple discovery of the cassandra seed node (which we will deploy shortly) we can create a \"headless\" service.  We do this by  specifying <strong>none</strong> for the  <strong>clusterIP</strong> in the <a href=\"https://github.com/IBM/Scalable-Cassandra-deployment-on-Kubernetes/blob/master/cassandra-service.yaml\">cassandra-service.yaml</a>. This headless service  allows us to use KubeDNS for the Pods to discover the IP address of the Cassandra seed.</p>\n<p>You can create the headless service using the <a href=\"https://github.com/IBM/Scalable-Cassandra-deployment-on-Kubernetes/blob/master/cassandra-service.yaml\">cassandra-service.yaml</a> file:</p>\n<div class=\"highlight highlight-source-shell\"><pre>$ kubectl create -f cassandra-service.yaml\nservice \"cassandra\" created\n$ kubectl get svc cassandra\nNAME        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE\ncassandra   None         &lt;none&gt;        9042/TCP   10s</pre></div>\n<p>Most applications deployed to Kubernetes should be cloud native and rely on external resources for their data (or state). However since Cassandra is a database we can use Stateful sets and Persistent Volumes to ensure resiliency in our database.</p>\n<h3><a id=\"user-content-2-create-local-volumes\" class=\"anchor\" aria-hidden=\"true\" href=\"#2-create-local-volumes\"></a>2. Create Local Volumes</h3>\n<p>To create persistent Cassandra nodes, we need to provision Persistent Volumes. There are two ways to provision PV's: <strong>dynamically and statically</strong>.</p>\n<p>For the sake of simplicity and compatibility we will use <strong>Static</strong> provisioning where we will create volumes manually using the provided yaml files.</p>\n<p><em>note: You'll need to have the same number of Persistent Volumes as the number of your Cassandra nodes. If you are expecting to have 3 Cassandra nodes, you'll need to create 3 Persistent Volumes.</em></p>\n<p>The provided <a href=\"https://github.com/IBM/Scalable-Cassandra-deployment-on-Kubernetes/blob/master/local-volumes.yaml\">local-volumes.yaml</a> file already has <strong>3</strong> Persistent Volumes defined. Update the file to add more if you expect to have greater than 3 Cassandra nodes. Create the volumes:</p>\n<div class=\"highlight highlight-source-shell\"><pre>$ kubectl create -f local-volumes.yaml\n$ kubectl get pv   \nNAME               CAPACITY   ACCESSMODES   RECLAIMPOLICY   STATUS      CLAIM     STORAGECLASS   REASON    AGE\ncassandra-data-1   1Gi        RWO           Recycle         Available                                      7s\ncassandra-data-2   1Gi        RWO           Recycle         Available                                      7s\ncassandra-data-3   1Gi        RWO           Recycle         Available                                      7s</pre></div>\n<h3><a id=\"user-content-3-create-a-statefulset\" class=\"anchor\" aria-hidden=\"true\" href=\"#3-create-a-statefulset\"></a>3. Create a StatefulSet</h3>\n<p>The <a href=\"https://github.com/IBM/Scalable-Cassandra-deployment-on-Kubernetes/blob/master/cassandra-statefulset.yaml\">StatefulSet</a> is responsible for creating the Pods. It provides ordered deployment, ordered termination and unique network names. Run the following command to start a single Cassandra server:</p>\n<div class=\"highlight highlight-source-shell\"><pre>$ kubectl create -f cassandra-statefulset.yaml</pre></div>\n<h3><a id=\"user-content-4-validate-the-statefulset\" class=\"anchor\" aria-hidden=\"true\" href=\"#4-validate-the-statefulset\"></a>4. Validate the StatefulSet</h3>\n<p>You can check if your StatefulSet has deployed using the command below.</p>\n<div class=\"highlight highlight-source-shell\"><pre>$ kubectl get statefulsets\nNAME        DESIRED   CURRENT   AGE\ncassandra   1         1         2h</pre></div>\n<p>If you view the list of the Pods, you should see 1 Pod running. Your Pod name should be cassandra-0 and the next pods would follow the ordinal number (<em>cassandra-1, cassandra-2,..</em>) Use this command to view the Pods created by the StatefulSet:</p>\n<div class=\"highlight highlight-source-shell\"><pre>$ kubectl get pods -o wide\nNAME          READY     STATUS    RESTARTS   AGE       IP              NODE\ncassandra-0   1/1       Running   0          1m        172.xxx.xxx.xxx   169.xxx.xxx.xxx</pre></div>\n<p>To check if the Cassandra node is up, perform a <strong>nodetool status:</strong></p>\n<div class=\"highlight highlight-source-shell\"><pre>$ kubectl exec -ti cassandra-0 -- nodetool status\nDatacenter: DC1\n===============\nStatus=Up/Down\n|/ State=Normal/Leaving/Joining/Moving\n--  Address          Load       Tokens       Owns (effective)   Host ID                               Rack\nUN  172.xxx.xxx.xxx  109.28 KB  256          100.0%             6402e90d-7995-4ee1-bb9c-36097eb2c9ec  Rack1</pre></div>\n<h3><a id=\"user-content-5-scale-the-statefulset\" class=\"anchor\" aria-hidden=\"true\" href=\"#5-scale-the-statefulset\"></a>5. Scale the StatefulSet</h3>\n<p>To increase or decrease the size of your StatefulSet you can use the scale command:</p>\n<div class=\"highlight highlight-source-shell\"><pre>$ kubectl scale --replicas=3 statefulset/cassandra</pre></div>\n<p>Wait a minute or two and check if it worked:</p>\n<div class=\"highlight highlight-source-shell\"><pre>$ kubectl get statefulsets\nNAME        DESIRED   CURRENT   AGE\ncassandra   3         3         2h</pre></div>\n<p>If you watch the Cassandra pods deploy, they should be created sequentially.</p>\n<p>You can view the list of the Pods again to confirm that your Pods are up and running.</p>\n<div class=\"highlight highlight-source-shell\"><pre>$ kubectl get pods -o wide\nNAME          READY     STATUS    RESTARTS   AGE       IP                NODE\ncassandra-0   1/1       Running   0          13m       172.xxx.xxx.xxx   169.xxx.xxx.xxx\ncassandra-1   1/1       Running   0          38m       172.xxx.xxx.xxx   169.xxx.xxx.xxx\ncassandra-2   1/1       Running   0          38m       172.xxx.xxx.xxx   169.xxx.xxx.xxx</pre></div>\n<p>You can perform a <strong>nodetool status</strong> to check if the other cassandra nodes have joined and formed a Cassandra cluster.</p>\n<p><em><strong>Note:</strong> It can take around 5 minutes for the Cassandra database to finish its setup.</em></p>\n<div class=\"highlight highlight-source-shell\"><pre>$ kubectl exec -ti cassandra-0 -- nodetool status\nDatacenter: DC1\n===============\nStatus=Up/Down\n|/ State=Normal/Leaving/Joining/Moving\n--  Address     Load       Tokens       Owns (effective)  Host ID                               Rack\nUN  172.xxx.xxx.xxx  103.25 KiB  256          68.7%             633ae787-3080-40e8-83cc-d31b62f53582  Rack1\nUN  172.xxx.xxx.xxx  108.62 KiB  256          63.5%             e95fc385-826e-47f5-a46b-f375532607a3  Rack1\nUN  172.xxx.xxx.xxx  177.38 KiB  256          67.8%             66bd8253-3c58-4be4-83ad-3e1c3b334dfd  Rack1</pre></div>\n<p><em>You will need to wait for the status of the nodes to be Up and Normal (UN) to execute the commands in the next steps.</em></p>\n<h3><a id=\"user-content-6-using-cql\" class=\"anchor\" aria-hidden=\"true\" href=\"#6-using-cql\"></a>6. Using CQL</h3>\n<p>You can access the cassandra container using the following command:</p>\n<div class=\"highlight highlight-source-shell\"><pre>kubectl exec -it cassandra-0 cqlsh    \nConnected to Cassandra at 127.0.0.1:9042.\n[cqlsh 5.0.1 | Cassandra 3.11.1 | CQL spec 3.4.4 | Native protocol v4]\nUse HELP for help.\ncqlsh&gt; describe tables\nKeyspace system_traces\n----------------------\nevents  sessions\nKeyspace system_schema\n----------------------\ntables     triggers    views    keyspaces  dropped_columns\nfunctions  aggregates  indexes  types      columns        \nKeyspace system_auth\n--------------------\nresource_role_permissons_index  role_permissions  role_members  roles\nKeyspace system\n---------------\navailable_ranges          peers               batchlog        transferred_ranges\nbatches                   compaction_history  size_estimates  hints             \nprepared_statements       sstable_activity    built_views   \n\"IndexInfo\"               peer_events         range_xfers   \nviews_builds_in_progress  paxos               local         \nKeyspace system_distributed\n---------------------------\nrepair_history  view_build_status  parent_repair_history\n</pre></div>\n<h2><a id=\"user-content-troubleshooting\" class=\"anchor\" aria-hidden=\"true\" href=\"#troubleshooting\"></a>Troubleshooting</h2>\n<ul><li>If your Cassandra instance is not running properly, you may check the logs using\n<ul><li><code>kubectl logs &lt;your-pod-name&gt;</code></li>\n</ul></li>\n<li>To clean/delete your data on your Persistent Volumes, delete your PVCs using\n<ul><li><code>kubectl delete pvc -l app=cassandra</code></li>\n</ul></li>\n<li>If your Cassandra nodes are not joining, delete your controller/statefulset then delete your Cassandra service.\n<ul><li><code>kubectl delete statefulset cassandra</code> if you created the Cassandra StatefulSet</li>\n<li><code>kubectl delete svc cassandra</code></li>\n</ul></li>\n<li>To delete everything:\n<ul><li><code>kubectl delete statefulset,pvc,pv,svc -l app=cassandra</code></li>\n</ul></li>\n</ul><h2><a id=\"user-content-references\" class=\"anchor\" aria-hidden=\"true\" href=\"#references\"></a>References</h2>"}}]}},"pageContext":{"alternative_id":12458}}